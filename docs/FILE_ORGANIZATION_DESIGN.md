# Koto 智能文件归纳系统设计文档

## 📋 需求分析

### 核心功能
1. **自动分类**：根据上传文件内容自动识别类型和主题
2. **智能归纳**：按行业、项目、类别自动创建或使用已有文件夹
3. **快速查找**：构建索引和搜索能力
4. **支持多行业**：金融、房产、医疗、教育等

### 应用场景
- 📊 **金融行业**：合同、凭证、财报按项目和日期分类
- 🏠 **房产行业**：物业、租赁、维修记录按物业分类
- 🏥 **医疗行业**：病历、处方、检查报告按患者分类
- 📚 **教育行业**：课程、作业、成绩按班级和科目分类
- 💼 **项目管理**：各类文档按项目和阶段分类

## 🏗️ 系统架构

### 文件结构
```
workspace/
├── _organize/                    # 归纳系统根目录
│   ├── index.json               # 全局索引（文件元数据）
│   ├── categories.json          # 分类配置和规则
│   ├── finance/                 # 金融项目
│   │   ├── 2026年预算/
│   │   ├── ABC融资合同/
│   │   └── _metadata.json       # 分类元数据
│   ├── projects/                # 通用项目
│   ├── documents/               # 通用文档
│   └── _logs/                   # 操作日志
└── ...其他上传文件夹
```

### 核心模块

| 模块 | 功能 | 涉及文件 |
|------|------|---------|
| **FileAnalyzer** | 文件内容分析与分类 | analyzer.py |
| **CategoryManager** | 分类规则管理 | categories.py |
| **FileOrganizer** | 文件归纳与移动 | organizer.py |
| **SearchIndex** | 全文搜索索引 | search.py |
| **API Routes** | Web接口 | app.py |

## 🧠 分类智能化设计

### 分类维度
1. **行业维度**：金融、房产、医疗、教育、其他
2. **类型维度**：合同、报告、凭证、记录、其他
3. **时间维度**：年份、季度、月份
4. **主题维度**：项目名、客户名、产品名

### AI分类流程
```
上传文件 
  ↓
提取文本内容 → 分析关键词
  ↓
识别行业、类型、主题、时间
  ↓
生成分类建议 → 用户确认/自动应用
  ↓
创建/移动到对应文件夹
  ↓
更新索引和元数据
```

### 分类规则示例

**金融类识别**：
- 关键词：合同、协议、凭证、发票、财报、融资、投资
- 文件类型：PDF合同、Excel财务表格、Word报告
- 时间提取：从文件名和内容中提取日期

**房产类识别**：
- 关键词：物业、租赁、维修、缴费、产权
- 主题识别：物业地址、房间号、住户名
- 自动分类：按物业→日期

## 🔧 实现细节

### API端点

```python
# 智能归纳接口
POST /api/organize/scan-file
  入参：file_path（新上传的文件）
  返回：分类建议、文件元数据

POST /api/organize/auto-organize  
  入参：file_path, auto_confirm=True/False
  返回：实际分类结果、新建的文件夹

GET /api/organize/list-categories
  返回：所有已有分类、统计信息

POST /api/organize/search
  入参：keywords, filters
  返回：搜索结果列表

GET /api/organize/stats
  返回：分类统计、行业分布、时间分析
```

### 数据结构

**索引文件 (_organize/index.json)**
```json
{
  "total_files": 150,
  "last_updated": "2026-02-13T12:00:00",
  "files": [
    {
      "original_path": "documents/report.pdf",
      "organized_path": "finance/2026年预算/Q1报告.pdf",
      "file_id": "uuid",
      "category": "financial_report",
      "industry": "finance",
      "keywords": ["预算", "Q1", "财务"],
      "upload_time": "2026-02-13",
      "size": 1024000,
      "checksum": "sha256..."
    }
  ]
}
```

**分类配置 (_organize/categories.json)**
```json
{
  "industries": {
    "finance": {
      "name": "金融",
      "keywords": ["合同", "凭证", "财报"],
      "subcategories": ["融资", "投资", "预算"]
    }
  },
  "rules": [
    {
      "pattern": "合同|协议",
      "industry": "finance",
      "type": "contract",
      "folder_template": "{year}/{quarter}/{subject}"
    }
  ]
}
```

## 📊 工作流程

### 1. 文件上传流程
```
用户上传文件
  → 触发自动分析
  → 显示分类建议
  → 用户可接受/修改/手动选择
  → 执行移动操作
  → 更新索引
```

### 2. 搜索流程
```
用户输入关键词
  → 查询索引和全文搜索
  → 返回匹配的文件
  → 显示所在分类路径
  → 支持快捷打开/预览
```

### 3. 统计分析
```
定期扫描_organize文件夹
  → 统计各分类文件数量
  → 分析上传趋势
  → 识别未分类文件
  → 生成行业分布报表
```

## 🚀 实现优先级

| 优先级 | 功能 | 工作量 |
|--------|------|--------|
| P0 | 基础文件分析和分类 | 2h |
| P0 | 自动创建文件夹和移动 | 1h |
| P0 | API接口 | 1h |
| P1 | 搜索和索引 | 2h |
| P1 | 统计和分析 | 1.5h |
| P2 | 自定义分类规则 | 2h |
| P2 | 预览和快速编辑 | 2h |
| P3 | 机器学习优化 | 3h |

## 💡 创新点

1. **多维分类**：不仅按类型，还按行业、时间、主题多维度
2. **智能建议**：用AI分析内容自动推荐分类
3. **灵活规则**：支持正则表达式和自定义规则
4. **快速查找**：全文索引 + 多条件过滤
5. **自学习**：记录用户选择，优化分类准确度

---

**接下来实现核心P0功能：文件分析 → 自动分类 → 归纳存储**
