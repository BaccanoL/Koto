# 📦 Koto 打包与图标更换指南

## 🎨 第一步：更新图标

### 方案A：使用新图标（推荐）
1. **保存新图标**
   - 右键点击聊天中的图标图片
   - 选择"另存为"
   - 保存到桌面，命名为 `new_icon.png`

2. **转换并替换图标**
   ```batch
   # 运行图标替换工具
   快速替换图标.bat
   ```
   - 将桌面的 `new_icon.png` 拖到窗口
   - 工具会自动：
     - 转换为 ICO 格式
     - 生成多尺寸图标
     - 备份旧图标
     - 替换新图标

### 方案B：手动替换（适合已有ICO文件）
1. 准备图标文件（必须是 `.ico` 格式）
2. 替换 `assets/koto_icon.ico`
3. 备份原文件（重命名为 `koto_icon.ico.old`）

---

## 🚀 第二步：打包成 EXE

### 快速打包（推荐）
直接双击运行：
```
快速打包.bat
```

**打包流程：**
1. ✅ 检查 Python 环境
2. ✅ 检查 PyInstaller（未安装会自动安装）
3. 🧹 清理旧的构建文件
4. 📦 使用 PyInstaller 打包
5. 📁 将 exe 复制到项目根目录
6. 📊 显示打包结果

**预计时间：** 2-5 分钟

---

## 📋 打包后的文件结构

```
Koto/
├── Koto.exe                    # ✨ 新生成的独立可执行文件
├── Koto_backup_20260213_*.exe  # 旧版本备份
├── dist/
│   └── Koto/                   # 完整的打包目录
│       ├── Koto.exe
│       ├── web/                # Web 资源
│       ├── config/             # 配置文件
│       ├── assets/             # 图标等资源
│       └── models/             # AI 模型
└── build/                      # 构建临时文件（可删除）
```

---

## 🎯 测试新 EXE

### 1. 关闭旧实例
```powershell
# PowerShell 命令
Get-Process -Name "python*","Koto" -ErrorAction SilentlyContinue | Stop-Process -Force
```

### 2. 运行新 EXE
直接双击 `Koto.exe`

### 3. 验证图标
- ✅ 任务栏显示新图标
- ✅ 窗口标题栏显示新图标
- ✅ Alt+Tab 切换显示新图标

---

## 🔧 高级选项

### 自定义打包配置
编辑 `build_koto.py`：

```python
# 修改版本号
VERSION = "1.0.2"

# 修改图标路径
ICON_FILE = "assets/my_custom_icon.ico"

# 添加更多隐藏导入
HIDDEN_IMPORTS = [
    'flask',
    'your_module_here',
]

# 添加更多数据目录
DATA_DIRS = [
    ('web', 'web'),
    ('my_data', 'my_data'),
]
```

### 单文件打包（不推荐，启动慢）
修改 `build_koto.py` 第 86 行：
```python
'--onefile',    # 改为单文件
# '--onedir',   # 注释掉单目录
```

---

## ❓ 常见问题

### Q1: 打包后 exe 很大（>100MB）？
**A:** 正常现象。包含了：
- Python 运行时
- Flask + Web 框架
- AI SDK (Google GenAI)
- 所有依赖库

### Q2: 打包失败，提示找不到模块？
**A:** 在 `build_koto.py` 的 `HIDDEN_IMPORTS` 中添加缺失的模块：
```python
HIDDEN_IMPORTS = [
    'missing_module',  # 添加这里
]
```

### Q3: 图标没有更新？
**A:** 检查：
1. `assets/koto_icon.ico` 是否已更新
2. 重新打包前需要清理缓存：
   ```batch
   rmdir /s /q build dist
   del *.spec
   ```
3. Windows 可能缓存了图标，重启资源管理器

### Q4: exe 启动很慢？
**A:** 
- 首次启动需要解压资源（5-10秒）
- 后续启动会快很多
- 单文件模式(`--onefile`)更慢，推荐使用单目录模式

### Q5: 能否减小 exe 大小？
**A:** 可以尝试：
1. 使用虚拟环境，只安装必需的包
2. 移除不需要的 `HIDDEN_IMPORTS`
3. 使用 UPX 压缩（可能导致误报病毒）

---

## 📝 完整打包流程示例

```batch
# 1. 更新图标
快速替换图标.bat
# （拖入新图标文件）

# 2. 清理旧构建（可选）
rmdir /s /q build dist
del *.spec

# 3. 打包
快速打包.bat

# 4. 测试
.\Koto.exe

# 5. 如果一切正常，可以删除构建临时文件
rmdir /s /q build
```

---

## 🎉 成功标志

打包成功后，你会看到：

```
✅ 打包成功！
📁 复制可执行文件...
   已备份旧版本: Koto_backup_20260213_135522.exe
✅ 已复制到: Koto.exe (7.85 MB)

📊 打包完成摘要
✅ 可执行文件: Koto.exe
   大小: 7.85 MB
   创建时间: 2026-02-13 13:55:25

🎯 下一步:
   1. 运行测试: .\Koto.exe
   2. 如需修改图标，请替换 assets/koto_icon.ico 后重新打包
   3. 完整包在: dist/Koto/
```

---

## 🔗 相关文件

- `build_koto.py` - 打包脚本（可自定义）
- `快速打包.bat` - 一键打包工具
- `快速替换图标.bat` - 图标替换工具
- `assets/koto_icon.ico` - 应用图标（22-24KB）

---

**最后更新：** 2026-02-13  
**适用版本：** Koto v1.0+
