# 智能文档分析引擎 - 使用指南

## 📌 概述

Koto现已升级为**智能文档分析引擎**，不再局限于"古板"的文件处理方式。新系统能够：

✅ **智能理解用户意图** - 自动识别多任务请求（如"写摘要+改引言+改结论"）  
✅ **结构化文档分析** - 理解文档的章节层次、标题结构、逻辑组织  
✅ **专用学术提示词** - 为摘要、引言、结论等不同部分生成专业提示词  
✅ **高质量学术写作** - 针对学术论文优化，生成符合学术规范的内容  
✅ **精准标红修改** - 只标红新增/修改的句子，保留原文为黑色  

---

## 🚀 使用方式

### 1. 上传Word文档（.docx/.doc）

在Koto对话界面，上传Word格式的文档（学术论文、报告等）。

### 2. 描述你的需求

支持**多任务组合请求**，系统会自动识别并分解任务：

#### 示例1：写摘要
```
写一段摘要，300-400字，包含研究背景、方法、结果、结论
```

#### 示例2：改进引言
```
改进引言部分，使其与文章主体架构相符
```

#### 示例3：改进结论
```
改善结论，overcap整篇文章内容
```

#### 示例4：多任务组合（推荐！）
```
写一段摘要，300-400字；重新改善引言，让其与文章主体架构相符；改善结论，overcap整篇文章内容
```

### 3. 自动生成并标红

系统将：
1. 📖 读取文档结构（章节、标题层次）
2. 🔍 分析你的请求意图（识别多任务）
3. 📋 分解为子任务（摘要/引言/结论等）
4. ✍️ 为每个任务生成专用提示词
5. 🤖 调用Gemini生成高质量内容
6. 📝 应用修改并标红（新内容为红色，原文为黑色）
7. 💾 保存标红版本到 `workspace/documents/`

---

## 🎯 智能特性

### 1. 多任务自动识别

以下关键词会触发相应任务：

| 任务类型 | 触发关键词 | 示例 |
|---------|-----------|------|
| 写摘要 | `写摘要`、`生成摘要`、`abstract` | "写一段300-400字的摘要" |
| 改引言 | `改引言`、`改进引言`、`重写引言` | "重新改善引言" |
| 改结论 | `改结论`、`改进结论`、`overcap` | "改善结论，overcap整篇文章" |
| 通用修改 | `改进`、`优化`、`润色` | "改进第三章的论述" |
| 文档分析 | `分析`、`总结`、`梳理` | "分析这篇论文的逻辑结构" |

### 2. 学术写作模板

系统内置专业的学术写作模板：

#### 摘要模板（4段结构）
1. **研究背景与目的**（80-100字） - 介绍研究领域背景和意义
2. **研究方法**（60-80字） - 描述方法论和分析方法
3. **研究结果**（100-120字） - 概括主要发现和创新点
4. **研究结论**（60-100字） - 总结贡献、局限性和未来方向

#### 引言模板（层次递进）
1. **问题提出** - 阐述核心问题
2. **层次展开** - 逐章介绍（第二章/第三章/第四章...）
3. **总体归纳** - 总结全文论证路径

#### 结论模板（全文总结）
1. **逐章概括** - 回顾每一章的主要内容和贡献
2. **理论综合** - 阐明章节间的逻辑递进关系
3. **贡献明确** - 概括核心贡献和创新点
4. **局限与展望** - 指出局限性和未来研究方向

### 3. 文档结构理解

系统会自动：
- 识别文档类型（学术论文/报告/文章）
- 提取标题层次（一级标题/二级标题...）
- 定位关键章节（摘要/引言/各章/结论）
- 理解章节间的逻辑关系

### 4. 精准标红

使用句子级diff对比：
- 🔴 **红色** = 新增或修改的句子
- ⚫ **黑色** = 保留的原文句子

避免整段标红，只标记实际修改的部分。

---

## 📊 工作流程

```
用户上传Word文档 + 描述需求
         ↓
   [智能意图分析]
    - 检测文档类型
    - 识别任务类型
    - 分解多任务
         ↓
   [结构化文档读取]
    - 提取章节层次
    - 定位关键段落
    - 理解逻辑结构
         ↓
   [专用提示词生成]
    - 摘要→学术摘要模板
    - 引言→层次递进模板
    - 结论→全文总结模板
         ↓
   [LLM高质量生成]
    - 使用Gemini-3-Pro
    - 结合文档结构
    - 生成学术规范内容
         ↓
   [句子级diff标红]
    - 对比原文与新文
    - 新增/修改→红色
    - 保留原文→黑色
         ↓
   [保存标红版本]
    - 输出到workspace/documents/
    - 文件名: 原文件名_revised_marked.docx
```

---

## ⚡ 触发条件

智能文档分析引擎会在以下情况自动启动：

1. **文件类型**：上传 `.docx` 或 `.doc` 文件
2. **请求模式**：用户输入包含以下模式之一：
   - `写.*摘要.*引言.*结论`
   - `摘要.*引言.*结论`
   - `写.*摘要.*改.*引言`
   - `改.*引言.*改.*结论`

如果不满足上述条件，系统会回退到原有的文件处理流程。

---

## 🎓 学术论文示例

### 输入
```
文档：数字之眼的危机——算法的形式主义危机.docx
请求：写一段摘要，300-400字；重新改善引言，让其与文章主体架构相符；改善结论，overcap整篇文章内容
```

### 系统处理流程
```
📖 正在读取文档结构... (10%)
   - 检测到88个段落
   - 识别文档类型: academic（学术论文）

🔍 分析用户需求... (20%)
   - 检测到3个任务：
     ✓ write_abstract (写摘要)
     ✓ revise_intro (改引言)
     ✓ revise_conclusion (改结论)

📋 识别到 3 个任务 (30%)

✍️ 正在处理: 根据要求生成论文摘要 (30-40%)
   - 使用学术摘要模板（4段结构）
   - 调用Gemini-3-Pro
   - 生成300-400字摘要

✅ 完成: write_abstract (40%)

✍️ 正在处理: 改进引言 (40-55%)
   - 使用层次递进模板
   - 结合文章章节结构
   - 生成与主体对应的引言

✅ 完成: revise_intro (55%)

✍️ 正在处理: 改进结论 (55-70%)
   - 使用全文总结模板
   - Overcap各章节内容
   - 生成综合性结论

✅ 完成: revise_conclusion (70%)

📝 正在应用修改并标红... (80%)
   - 句子级diff对比
   - 新增/修改句子标红
   - 保留原文为黑色

✅ 文档修订完成 (100%)
   - 输出文件: 数字之眼的危机_revised_marked.docx
   - 任务数: 3
   - 修订部分: abstract, intro, conclusion
```

---

## 🔧 技术架构

### 核心模块

1. **IntelligentDocumentAnalyzer** (`web/intelligent_document_analyzer.py`)
   - 文档结构分析
   - 用户意图理解
   - 任务分解与调度
   - 专用提示词生成
   - 流式处理与标红

2. **DocumentReader** (`web/document_reader.py`)
   - 结构化文档读取
   - 标题层次提取
   - 段落类型识别
   - 格式化信息保留

3. **集成点** (`web/app.py`)
   - `/api/chat/file` endpoint
   - 在L9207后插入智能分析路由
   - 检测多任务学术请求模式

### 关键算法

- **意图分析**：正则表达式 + 关键词匹配 + 置信度评分
- **任务分解**：模式识别 + 需求提取
- **结构定位**：标题检测 + 段落索引
- **Diff标红**：difflib.SequenceMatcher + 句子级对比

---

## ✨ 优势对比

| 特性 | 旧系统（古板） | 新系统（智能） |
|-----|-------------|-------------|
| 文档理解 | 纯文本提取 | 结构化分析（标题层次） |
| 意图识别 | 关键词简单匹配 | 多任务智能分解 |
| 提示词 | 通用Chat指令 | 学术专用模板 |
| 任务处理 | 单一整体任务 | 多任务并行处理 |
| 标红精度 | 整段标红（过度） | 句子级精准标红 |
| 质量控制 | 无 | 学术规范校验 |

---

## 🐛 限制与注意事项

1. **文件格式**：仅支持 `.docx` 和 `.doc`，不支持PDF
2. **触发条件**：必须包含多任务模式才会启动智能引擎（否则回退到原流程）
3. **LLM依赖**：依赖Gemini API，需要配置API密钥
4. **处理时间**：多任务请求可能需要1-3分钟（取决于任务数量）
5. **文档大小**：超大文档（>10000段落）可能导致处理变慢

---

## 📝 测试验证

运行测试脚本验证系统功能：

```bash
cd c:\Users\12524\Desktop\Koto
python test_intelligent_analyzer.py
```

测试内容：
- ✅ 文档结构分析
- ✅ 请求意图识别
- ✅ 专用提示词生成
- ✅ 完整流式处理流程

---

## 🎉 总结

智能文档分析引擎已成功升级并通过测试！现在Koto能够：

1. **理解你的意图** - 不再"古板"，智能识别多任务
2. **分析文档结构** - 理解章节层次和逻辑关系
3. **生成高质量内容** - 学术规范的摘要、引言、结论
4. **精准标红修改** - 只标记实际修改的部分

**下次使用时，只需上传Word文档并描述需求，系统会自动处理一切！** 🚀

---

## 📞 问题反馈

如果遇到问题或希望改进，请查看：
- 测试日志：`test_intelligent_analyzer.py` 输出
- 错误日志：控制台错误信息
- 文档结构：检查 `DocumentReader.read_word()` 输出

---

**版本**: 1.0.0  
**更新时间**: 2024  
**开发者**: Koto AI Team
