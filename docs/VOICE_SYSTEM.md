# Koto 快速语音识别系统

## 🎯 更新内容

已完成语音识别系统重做，使用**快速本地识别**方案：

### ✅ 新特性

1. **快速响应**
   - 默认3-5秒超时（可调整）
   - 静音检测优化（0.5秒即判定结束）
   - 环境噪音快速校准（0.3秒）

2. **本地优先**  
   - 主引擎：Google Web Speech API（需网络，效果最佳）
   - 备用引擎：Windows SAPI（本地，无需网络）
   - 降级方案：离线录音保存

3. **打包环境完美支持**
   - 移除了vosk依赖（在打包环境中有问题）
   - 使用`speech_recognition`库（轻量可靠）
   - 自动检测并适配可用引擎

### 📋 可用引擎

| 引擎 | 类型 | 速度 | 准确度 | 要求 |
|------|------|------|--------|------|
| **Google Web Speech** 🟢 | 在线 | ⚡快 | ⭐⭐⭐⭐⭐ | 需网络 |
| Windows SAPI | 本地 | ⚡⚡快 | ⭐⭐⭐ | 无 |
| Gemini API | 在线 | 中 | ⭐⭐⭐⭐ | 需网络+API Key |
| 离线录音 | 本地 | 即时 | N/A | 手动处理 |

## 🎤 使用方法 

### 1. 基础使用

1. 点击Koto右下角的 **🎙️ 语音输入** 按钮
2. 看到"开始识别..."提示后，**对着麦克风说话**
3. 说完后保持安静0.5秒，系统自动结束识别
4. 识别结果会自动填入输入框

### 2. 快捷键（如支持）

- `Ctrl+Alt+V` - 快速开启语音输入  
- 说完话后自动提交（可在设置中关闭）

### 3. 设置调整

在设置面板中可配置：
- **语音输入自动发送**：识别完成后自动发送给AI
- **语音自动上传模式**：说完自动结束 vs 手动点击确认
- **超时时间**：默认5秒，可调整

## 🔧 技术细节

### 核心文件

- `web/voice_fast.py` - 新的快速语音识别模块
- `web/app.py` - API路由（已更新到快速模块）

### API端点

```python
# 获取可用引擎
GET /api/voice/engines

# 快速识别（非流式）
POST /api/voice/listen
Body: {"timeout": 5, "language": "zh-CN"}

# 流式识别（SSE）
GET /api/voice/stream
```

### 代码示例

```python
from web.voice_fast import get_recognizer

# 快速识别
recognizer = get_recognizer()
result = recognizer.recognize(timeout=5, language='zh-CN')

if result.success:
    print(f"识别结果: {result.text}")
    print(f"使用引擎: {result.engine}")
else:
    print(f"识别失败: {result.message}")
```

## 🚀 性能优化

1. **快速启动**：引擎检测缓存，首次启动后秒开
2. **低延迟**：环境校准仅0.3秒，静音判定0.5秒
3. **智能降级**：网络不可用时自动切换本地引擎
4. **内存优化**：单例模式，避免重复初始化

## ⚠️ 故障排除

### 问题1：点击后无反应

**原因**：麦克风权限未授予
**解决**：
1. Windows设置 → 隐私 → 麦克风
2. 确保允许应用访问麦克风
3. 重启Koto

### 问题2："未检测到语音"

**原因**：环境太安静或麦克风音量太低
**解决**：
1. 检查麦克风是否静音
2. 系统设置 → 声音 → 输入设备音量调大
3. 靠近麦克风说话（15-30cm）

### 问题3："识别失败（需网络）"

**原因**：Google API不可用（无网络/被墙）
**解决方案**：
- 方案A：连接网络并确保可访问Google服务
- 方案B：使用代理/VPN
- 方案C：等待自动切换到Windows SAPI本地引擎

### 问题4：识别不准确

**优化建议**：
1. **清晰发音**：吐字清楚，语速适中
2. **安静环境**：减少背景噪音
3. **合适距离**：麦克风15-30cm最佳
4. **完整语句**：说完整句子，不要断断续续

## 📝 更新日志

### v1.1.0 (2026-02-13)

✅ 重做语音识别系统
✅ 移除vosk依赖（打包环境兼容性问题）
✅ 使用speech_recognition + Google Web Speech
✅ 优化识别速度和响应时间
✅ 添加本地降级方案（Windows SAPI）
✅ 改进错误处理和用户提示

### v1.0.0 (之前版本)

- 初始语音功能
- 使用vosk本地识别（打包环境问题）
- 多引擎支持但不稳定

## 💡 最佳实践

1. **网络连接**：保持网络畅通以使用Google识别（最佳效果）
2. **简短指令**：3-8秒的语句识别效果最好
3. **标准普通话**：方言识别率较低
4. **避免口语化**：少用"呃"、"啊"等语气词

## 🎯 后续计划

- [ ] 支持本地Whisper模型（完全离线，高准确度）
- [ ] 多语言切换（英语、粤语等）
- [ ] 语音指令系统（"打开文件"、"搜索"等）
- [ ] 实时转写（边说边显示）
- [ ] 语音唤醒（"Hi Koto"）

---

**享受快速流畅的语音输入体验！** 🎤✨
