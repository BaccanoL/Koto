<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koto</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            height: 100vh;
            overflow: hidden;
            color: #334155;
            opacity: 1;
            transition: opacity 0.15s ease-in;
        }
        .app { height: 100%; display: flex; flex-direction: column; }
        
        .top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #fff;
            border-bottom: 1px solid #e2e8f0;
        }
        .logo { font-size: 14px; font-weight: 600; color: #64748b; display: flex; align-items: center; gap: 4px; }
        .logo span { color: #3b82f6; font-size: 16px; }
        .expand { background: #f1f5f9; border: 1px solid #e2e8f0; color: #64748b; padding: 4px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .expand:hover { background: #e2e8f0; color: #3b82f6; }
        
        .chat { flex: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 6px; background: #f8fafc; }
        .chat::-webkit-scrollbar { width: 3px; }
        .chat::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .m { max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 13px; line-height: 1.4; word-wrap: break-word; }
        .m.u { align-self: flex-end; background: #3b82f6; color: #fff; border-bottom-right-radius: 4px; }
        .m.a { align-self: flex-start; background: #fff; color: #334155; border: 1px solid #e2e8f0; border-bottom-left-radius: 4px; }
        .m.s { align-self: center; background: none; color: #94a3b8; font-size: 11px; padding: 2px; }
        
        .dots { display: flex; gap: 3px; }
        .dots i { width: 5px; height: 5px; background: #3b82f6; border-radius: 50%; animation: b 1.2s infinite; }
        .dots i:nth-child(2) { animation-delay: 0.15s; }
        .dots i:nth-child(3) { animation-delay: 0.3s; }
        @keyframes b { 0%,60%,100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }
        
        .bar { display: flex; gap: 6px; padding: 8px 10px; background: #fff; border-top: 1px solid #e2e8f0; }
        .bar input { flex: 1; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 16px; padding: 8px 14px; color: #334155; font-size: 13px; outline: none; min-width: 0; }
        .bar input:focus { border-color: #3b82f6; }
        .bar input::placeholder { color: #94a3b8; }
        .bar button { width: 32px; height: 32px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
        .mic { background: #f1f5f9; color: #64748b; transition: all 0.2s; }
        .mic:hover { background: #e2e8f0; }
        .mic.on { background: #ef4444; color: #fff; animation: pulse 1s infinite; width: 80px; border-radius: 16px; }
        .mic.on::after { content: 'ÁÇπÂáªÂÅúÊ≠¢'; font-size: 10px; margin-left: 4px; }
        @keyframes pulse { 50% { transform: scale(1.02); } }
        .send { background: #3b82f6; color: #fff; }
        .send:hover { background: #2563eb; }
        
        .pv { position: absolute; bottom: 100%; left: 8px; right: 8px; background: #fff; border: 1px solid #3b82f6; padding: 8px 12px; border-radius: 8px; font-size: 13px; color: #334155; display: none; margin-bottom: 4px; box-shadow: 0 2px 12px rgba(59,130,246,0.2); }
        .pv.show { display: block; }
        .pv .label { color: #3b82f6; font-size: 11px; margin-bottom: 4px; }
        .pv .text { min-height: 20px; }
        .pv .hint { color: #94a3b8; font-size: 10px; margin-top: 4px; }
        .wrap { flex: 1; position: relative; min-width: 0; }
    </style>
</head>
<body>
    <div class="app">
        <div class="top">
            <div class="logo"><span>Ë®Ä</span>Koto</div>
            <button class="expand" onclick="go()">‚¨à Â±ïÂºÄ</button>
        </div>
        <div class="chat" id="c"></div>
        <div class="bar">
            <div class="wrap">
                <div class="pv" id="pv">
                    <div class="label">üé§ Ê≠£Âú®ËÅÜÂê¨...</div>
                    <div class="text" id="pvText"></div>
                    <div class="hint"></div>
                </div>
                <input id="q" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." onkeypress="if(event.key==='Enter')ask()">
            </div>
            <button class="mic" id="mic" onclick="vc()">üéôÔ∏è</button>
            <button class="send" onclick="ask()">‚û§</button>
        </div>
    </div>
    <script>
        let on = false;
        let voiceSource = null;  // EventSource ÂØπË±°
        let voiceAutoMode = true; // ÈªòËÆ§Ëá™Âä®Ê®°Âºè
        let pendingText = '';     // ÊâãÂä®Ê®°ÂºèÊöÇÂ≠òÊñáÊú¨
        
        // Âä†ËΩΩËÆæÁΩÆ
        async function loadVoiceSettings() {
            try {
                const r = await fetch('/api/settings');
                const s = await r.json();
                voiceAutoMode = s.ai?.voice_auto_mode !== false;
            } catch (e) {}
        }
        loadVoiceSettings();
        
        function add(t, x) {
            const d = document.createElement('div');
            d.className = 'm ' + t;
            d.innerHTML = x.replace(/\n/g, '<br>');
            document.getElementById('c').appendChild(d);
            d.scrollIntoView({ behavior: 'smooth' });
        }
        
        function typ(s) {
            let t = document.getElementById('t');
            if (s && !t) {
                t = document.createElement('div');
                t.id = 't';
                t.className = 'm a';
                t.innerHTML = '<div class="dots"><i></i><i></i><i></i></div>';
                document.getElementById('c').appendChild(t);
                t.scrollIntoView({ behavior: 'smooth' });
            } else if (!s && t) {
                t.remove();
            }
        }
        
        async function ask() {
            const q = document.getElementById('q');
            const m = q.value.trim();
            if (!m) return;
            q.value = '';
            add('u', m);
            typ(1);
            try {
                const r = await fetch('/api/mini/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: m })
                });
                typ(0);
                if (r.ok) {
                    const d = await r.json();
                    add('a', d.response || '...');
                } else {
                    add('a', 'ËØ∑Ê±ÇÂ§±Ë¥•');
                }
            } catch (e) {
                typ(0);
                add('s', '‚ö† ËøûÊé•Â§±Ë¥•');
            }
        }
        
        async function vc() {
            // Â¶ÇÊûúÊ≠£Âú®ÂΩïÈü≥ÔºåÁÇπÂáªÂ§ÑÁêÜ
            if (on) {
                // ÊâãÂä®Ê®°ÂºèÔºöÁÇπÂáªÂèëÈÄÅ
                if (!voiceAutoMode && pendingText) {
                    document.getElementById('q').value = pendingText;
                    pendingText = '';
                    stopVoice();
                    ask();
                    return;
                }
                stopVoice();
                return;
            }
            
            on = true;
            pendingText = '';
            const mic = document.getElementById('mic');
            const pv = document.getElementById('pv');
            const pvText = document.getElementById('pvText');
            
            mic.classList.add('on');
            mic.textContent = '‚èπ';
            pv.classList.add('show');
            pvText.textContent = '';
            
            // Ê†πÊçÆÊ®°ÂºèÊòæÁ§∫‰∏çÂêåÊèêÁ§∫
            const modeHint = voiceAutoMode 
                ? 'üü¢ Ëá™Âä®Ê®°Âºè - ËØ¥ÂÆåËá™Âä®ÂèëÈÄÅ' 
                : 'üü° ÊâãÂä®Ê®°Âºè - ÁÇπÂáªÈ∫¶ÂÖãÈ£éÁ°ÆËÆ§';
            document.querySelector('#pv .label').textContent = 'üé§ Ê≠£Âú®ËÅÜÂê¨...';
            document.querySelector('#pv .hint').textContent = modeHint;
            
            try {
                // ‰ΩøÁî®ÊµÅÂºè API
                voiceSource = new EventSource('/api/voice/stream');
                
                voiceSource.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'partial') {
                        // Áä∂ÊÄÅÊ∂àÊÅØÊòæÁ§∫Âú®Ê†áÁ≠æÔºå‰∏çÊòØÊñáÊú¨Âå∫
                        if (data.text && (data.text.includes('üé§') || data.text.includes('üéß') || data.text.includes('‚ú®') || data.text.includes('‚è±Ô∏è'))) {
                            // ËøôÊòØÁä∂ÊÄÅÊ∂àÊÅØ
                            document.querySelector('#pv .label').textContent = data.text;
                        } else {
                            // ËøôÊòØËØÜÂà´ÁöÑÊñáÂ≠ó
                            pvText.textContent = data.text;
                            pendingText = data.text;
                            document.querySelector('#pv .label').textContent = '‚ú® Ê≠£Âú®ËØÜÂà´...';
                        }
                    } else if (data.type === 'final') {
                        if (voiceAutoMode) {
                            // Ëá™Âä®Ê®°ÂºèÔºöÁõ¥Êé•ÂèëÈÄÅ
                            stopVoice();
                            if (data.text) {
                                document.getElementById('q').value = data.text;
                                ask();
                            }
                        } else {
                            // ÊâãÂä®Ê®°ÂºèÔºöÁ≠âÂæÖÁÇπÂáªÁ°ÆËÆ§
                            pendingText = data.text;
                            pvText.textContent = data.text;
                            document.querySelector('#pv .label').textContent = '‚úÖ ËØÜÂà´ÂÆåÊàê';
                            document.querySelector('#pv .hint').textContent = 'üëÜ ÁÇπÂáªÈ∫¶ÂÖãÈ£éÂèëÈÄÅ';
                        }
                    } else if (data.type === 'error') {
                        stopVoice();
                        if (data.message !== 'Êú™Ê£ÄÊµãÂà∞ËØ≠Èü≥') {
                            add('s', data.message || 'ËØÜÂà´Â§±Ë¥•');
                        }
                    }
                };
                
                voiceSource.onerror = () => {
                    stopVoice();
                    vcFallback();
                };
                
            } catch (e) {
                stopVoice();
                add('s', 'ËØ≠Èü≥ÊúçÂä°‰∏çÂèØÁî®');
            }
        }
        
        function stopVoice() {
            if (voiceSource) {
                voiceSource.close();
                voiceSource = null;
            }
            on = false;
            pendingText = '';
            const mic = document.getElementById('mic');
            mic.classList.remove('on');
            mic.textContent = 'üéôÔ∏è';
            document.getElementById('pv').classList.remove('show');
            fetch('/api/voice/stop', { method: 'POST' }).catch(() => {});
        }
        
        // ÈùûÊµÅÂºè API ÈôçÁ∫ßÊñπÊ°à
        async function vcFallback() {
            if (on) return;
            on = true;
            document.getElementById('mic').classList.add('on');
            document.getElementById('mic').textContent = '‚èπ';
            document.getElementById('pv').classList.add('show');
            document.getElementById('pvText').textContent = 'Ê≠£Âú®ËÅÜÂê¨...';
            
            try {
                const r = await fetch('/api/voice/listen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timeout: 8, language: 'zh-CN' })
                });
                
                const d = await r.json();
                document.getElementById('pv').classList.remove('show');
                
                if (d.success && d.text) {
                    document.getElementById('q').value = d.text;
                    ask();
                } else {
                    add('s', d.message || 'Êú™ËÉΩËØÜÂà´');
                }
            } catch (e) {
                document.getElementById('pv').classList.remove('show');
                add('s', 'ËØ≠Èü≥ÊúçÂä°‰∏çÂèØÁî®');
            } finally {
                on = false;
                document.getElementById('mic').classList.remove('on');
                document.getElementById('mic').textContent = 'üéôÔ∏è';
            }
        }
        
        async function go() {
            if (window.pywebview && window.pywebview.api && window.pywebview.api.switch_to_full) {
                await pywebview.api.switch_to_full();
            } else {
                // ‰ºòÂåñÁöÑË∑≥ËΩ¨ÊµÅÁ®ã
                document.body.style.transition = 'opacity 0.15s ease-out';
                document.body.style.opacity = '0';
                
                // È¢ÑÂä†ËΩΩÊ†áÂáÜÁâàÈ°µÈù¢
                const link = document.createElement('link');
                link.rel = 'prefetch';
                link.href = '/';
                document.head.appendChild(link);
                
                setTimeout(() => {
                    window.location.href = '/';
                }, 150);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('q').focus();
            
            // È°µÈù¢Âä†ËΩΩÊó∂Ê∑°ÂÖ•Âä®Áîª
            if (document.body.style.opacity === '0') {
                setTimeout(() => {
                    document.body.style.opacity = '1';
                }, 50);
            }
        });
    </script>
</body>
</html>
