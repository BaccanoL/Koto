<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koto PPT ç¼–è¾‘å™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f7fa; }
        
        .container { display: flex; height: 100vh; }
        
        .sidebar {
            width: 300px;
            background: #fff;
            border-right: 1px solid #e1e4e8;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e1e4e8;
            background: #f6f8fa;
        }
        
        .sidebar-title { font-size: 16px; font-weight: 600; color: #333; }
        .sidebar-subtitle { font-size: 12px; color: #666; margin-top: 8px; }
        
        .slides-list {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }
        
        .slide-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f6f8fa;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }
        
        .slide-item:hover { background: #eef2f7; }
        .slide-item.active {
            background: #fff;
            border-color: #0366d6;
            box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
        }
        
        .slide-item-title { font-size: 13px; font-weight: 500; color: #333; }
        .slide-item-type { font-size: 11px; color: #666; margin-top: 4px; }
        
        .editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 30px;
            overflow-y: auto;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .editor-title { font-size: 24px; font-weight: 600; color: #333; }
        
        .editor-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #0366d6;
            color: white;
        }
        
        .btn-primary:hover { background: #0356c3; }
        
        .btn-secondary {
            background: #f6f8fa;
            color: #333;
            border: 1px solid #e1e4e8;
        }
        
        .btn-secondary:hover { background: #eef2f7; }
        
        .btn-danger {
            background: #d73a49;
            color: white;
        }
        
        .btn-danger:hover { background: #cb2431; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .points-list {
            margin: 15px 0;
        }
        
        .point-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-start;
        }
        
        .point-input {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-small:hover { background: #eef2f7; }
        
        .slide-type-badge {
            display: inline-block;
            padding: 2px 6px;
            background: #0366d6;
            color: white;
            border-radius: 3px;
            font-size: 11px;
            margin-bottom: 15px;
        }
        
        .loading { color: #666; font-size: 14px; }
        .error { color: #d73a49; padding: 15px; background: #fdeaea; border-radius: 6px; }
        .success { color: #28a745; padding: 15px; background: #e8f5e9; border-radius: 6px; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }
        
        .modal-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; }
        
        .modal-textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            font-size: 13px;
            font-family: monospace;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹æ ï¼šå¹»ç¯ç‰‡åˆ—è¡¨ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title" id="ppt-title">æ¼”ç¤ºæ–‡ç¨¿</div>
                <div class="sidebar-subtitle" id="ppt-pages">0 é¡µ</div>
            </div>
            <div class="slides-list" id="slides-list"></div>
            <div style="padding: 15px; border-top: 1px solid #e1e4e8;">
                <button class="btn btn-primary" onclick="addNewSlide()" style="width: 100%;">+ æ–°å¹»ç¯ç‰‡</button>
            </div>
        </div>
        
        <!-- ç¼–è¾‘åŒº -->
        <div class="editor">
            <div class="editor-header">
                <div class="editor-title">ç¼–è¾‘å¹»ç¯ç‰‡</div>
                <div class="editor-actions">
                    <button class="btn btn-secondary" onclick="downloadPPT()">â¬‡ï¸ ä¸‹è½½</button>
                    <button class="btn btn-primary" onclick="savePPT()">ğŸ’¾ ä¿å­˜ & æ¸²æŸ“</button>
                </div>
            </div>
            
            <div id="editor-content">
                <div class="loading">é€‰æ‹©ä¸€ä¸ªå¹»ç¯ç‰‡è¿›è¡Œç¼–è¾‘...</div>
            </div>
        </div>
    </div>
    
    <!-- é‡æ–°ç”Ÿæˆå¯¹è¯æ¡† -->
    <div class="modal" id="regenerate-modal">
        <div class="modal-content">
            <div class="modal-title">é‡æ–°ç”Ÿæˆå¹»ç¯ç‰‡å†…å®¹</div>
            <p style="margin-bottom: 15px; color: #666;">
                ä½¿ç”¨ AI é‡æ–°ç”Ÿæˆè¯¥é¡µå†…å®¹ã€‚æ‚¨å¯ä»¥è‡ªå®šä¹‰æç¤ºè¯ï¼Œæˆ–ä½¿ç”¨é»˜è®¤æç¤ºã€‚
            </p>
            <textarea class="modal-textarea" id="regenerate-prompt" placeholder="ï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤æç¤ºè¯ï¼‰"></textarea>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="doRegenerate()" style="flex: 1;">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                <button class="btn btn-secondary" onclick="closeRegenerateModal()" style="flex: 1;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        let sessionId = null;
        let currentSlideIndex = null;
        let pptData = null;
        
        // ä» URL è·å– session_id
        function initSession() {
            const path = window.location.pathname;
            const match = path.match(/\/edit-ppt\/([a-f0-9\-]+)/);
            if (match) {
                sessionId = match[1];
                loadSession();
            }
        }
        
        async function loadSession() {
            try {
                const response = await fetch(`/api/ppt/session/${sessionId}`);
                const result = await response.json();
                
                if (!result.success) {
                    document.getElementById('editor-content').innerHTML = 
                        `<div class="error">åŠ è½½ä¼šè¯å¤±è´¥: ${result.error}</div>`;
                    return;
                }
                
                pptData = result.data.ppt_data;
                updateUI();
            } catch (err) {
                document.getElementById('editor-content').innerHTML = 
                    `<div class="error">åŠ è½½å¤±è´¥: ${err.message}</div>`;
            }
        }
        
        function updateUI() {
            if (!pptData) return;
            
            // æ›´æ–°æ ‡é¢˜å’Œé¡µæ•°
            document.getElementById('ppt-title').textContent = pptData.title || 'æ¼”ç¤ºæ–‡ç¨¿';
            document.getElementById('ppt-pages').textContent = `${pptData.slides.length} é¡µ`;
            
            // æ„å»ºå¹»ç¯ç‰‡åˆ—è¡¨
            const slidesList = document.getElementById('slides-list');
            slidesList.innerHTML = '';
            
            pptData.slides.forEach((slide, idx) => {
                const item = document.createElement('div');
                item.className = `slide-item ${idx === currentSlideIndex ? 'active' : ''}`;
                item.onclick = () => selectSlide(idx);
                
                item.innerHTML = `
                    <div class="slide-item-title">${slide.title || `å¹»ç¯ç‰‡ ${idx + 1}`}</div>
                    <div class="slide-item-type">${getSlideTypeLabel(slide.type)}</div>
                `;
                
                slidesList.appendChild(item);
            });
            
            // åŠ è½½å½“å‰é€‰ä¸­çš„å¹»ç¯ç‰‡ç¼–è¾‘åŒº
            if (currentSlideIndex !== null && currentSlideIndex < pptData.slides.length) {
                renderEditor();
            }
        }
        
        function selectSlide(idx) {
            currentSlideIndex = idx;
            updateUI();
        }
        
        function renderEditor() {
            if (currentSlideIndex === null || !pptData) return;
            
            const slide = pptData.slides[currentSlideIndex];
            const typeLabel = getSlideTypeLabel(slide.type);
            
            let html = `
                <div class="slide-type-badge">${typeLabel}</div>
                
                <div class="form-group">
                    <label class="form-label">å¹»ç¯ç‰‡æ ‡é¢˜</label>
                    <input type="text" class="form-input" id="slide-title" 
                        value="${slide.title || ''}" placeholder="è¾“å…¥å¹»ç¯ç‰‡æ ‡é¢˜">
                </div>
                
                <div class="form-group">
                    <label class="form-label">å¹»ç¯ç‰‡ç±»å‹</label>
                    <select class="form-select" id="slide-type">
                        <option value="detail" ${slide.type === 'detail' ? 'selected' : ''}>è¯¦ç»†ï¼ˆå¤šè¦ç‚¹ï¼‰</option>
                        <option value="overview" ${slide.type === 'overview' ? 'selected' : ''}>æ¦‚è§ˆï¼ˆå¤šå­ä¸»é¢˜ï¼‰</option>
                        <option value="highlight" ${slide.type === 'highlight' ? 'selected' : ''}>äº®ç‚¹ï¼ˆæ•°æ®çªå‡ºï¼‰</option>
                        <option value="comparison" ${slide.type === 'comparison' ? 'selected' : ''}>å¯¹æ¯”ï¼ˆå·¦å³å¹¶æ’ï¼‰</option>
                        <option value="divider" ${slide.type === 'divider' ? 'selected' : ''}>è¿‡æ¸¡ï¼ˆåˆ†éš”ï¼‰</option>
                    </select>
                </div>
            `;
            
            if (slide.type === 'divider') {
                html += `
                    <div class="form-group">
                        <label class="form-label">è¿‡æ¸¡æè¿°</label>
                        <textarea class="form-textarea" id="slide-description" 
                            placeholder="è¾“å…¥è¿‡æ¸¡é¡µæè¿°">${slide.description || ''}</textarea>
                    </div>
                `;
            } else if (slide.type === 'overview' || slide.type === 'comparison') {
                html += renderSubsectionsEditor(slide);
            } else {
                html += renderPointsEditor(slide);
            }
            
            html += `
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="updateCurrentSlide()">âœ… ä¿å­˜ç¼–è¾‘</button>
                    <button class="btn btn-secondary" onclick="openRegenerateModal()">ğŸ”„ AI é‡æ–°ç”Ÿæˆ</button>
                    <button class="btn btn-danger" onclick="deleteCurrentSlide()">ğŸ—‘ï¸ åˆ é™¤</button>
                </div>
            `;
            
            document.getElementById('editor-content').innerHTML = html;
        }
        
        function renderPointsEditor(slide) {
            const points = slide.points || slide.content || [];
            let html = `
                <div class="form-group">
                    <label class="form-label">è¦ç‚¹å†…å®¹</label>
                    <div class="points-list" id="points-list">
            `;
            
            points.forEach((point, idx) => {
                html += `
                    <div class="point-item">
                        <input type="text" class="point-input" value="${point}" 
                            onchange="updatePoint(${idx}, this.value)">
                        <button class="btn-small" onclick="deletePoint(${idx})">åˆ é™¤</button>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <button class="btn btn-secondary" onclick="addPoint()">+ æ·»åŠ è¦ç‚¹</button>
                </div>
            `;
            
            return html;
        }
        
        function renderSubsectionsEditor(slide) {
            const subs = slide.subsections || [];
            let html = `<div class="form-group"><label class="form-label">å­ä¸»é¢˜ä¸è¦ç‚¹</label>`;
            
            subs.forEach((sub, sidx) => {
                html += `
                    <div style="background: #f6f8fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <input type="text" class="form-input" value="${sub.subtitle || ''}" 
                            placeholder="å­ä¸»é¢˜æ ‡é¢˜" style="margin-bottom: 10px;"
                            onchange="updateSubtitle(${sidx}, this.value)">
                        <div class="points-list">
                `;
                
                (sub.points || []).forEach((point, pidx) => {
                    html += `
                        <div class="point-item">
                            <input type="text" class="point-input" value="${point}"
                                onchange="updateSubPoint(${sidx}, ${pidx}, this.value)">
                            <button class="btn-small" onclick="deleteSubPoint(${sidx}, ${pidx})">åˆ é™¤</button>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <button class="btn btn-secondary" style="font-size: 12px; width: 100%; margin-top: 10px;"
                            onclick="addSubPoint(${sidx})">+ æ·»åŠ è¦ç‚¹</button>
                    </div>
                `;
            });
            
            html += `<button class="btn btn-secondary" onclick="addSubsection()">+ æ·»åŠ å­ä¸»é¢˜</button></div>`;
            return html;
        }
        
        // ç¼–è¾‘æ“ä½œ
        function updateCurrentSlide() {
            if (!pptData || currentSlideIndex === null) return;
            
            const slide = pptData.slides[currentSlideIndex];
            slide.title = document.getElementById('slide-title').value;
            slide.type = document.getElementById('slide-type').value;
            
            if (slide.type === 'divider' && document.getElementById('slide-description')) {
                slide.description = document.getElementById('slide-description').value;
            }
            
            updateUI();
            showMessage('å¹»ç¯ç‰‡å·²æ›´æ–°', 'success');
        }
        
        function updatePoint(idx, value) {
            const slide = pptData.slides[currentSlideIndex];
            if (slide.points) slide.points[idx] = value;
            if (slide.content) slide.content[idx] = value;
        }
        
        function addPoint() {
            const slide = pptData.slides[currentSlideIndex];
            if (!slide.points) slide.points = [];
            if (!slide.content) slide.content = [];
            slide.points.push('æ–°è¦ç‚¹');
            slide.content.push('æ–°è¦ç‚¹');
            renderEditor();
        }
        
        function deletePoint(idx) {
            const slide = pptData.slides[currentSlideIndex];
            if (slide.points) slide.points.splice(idx, 1);
            if (slide.content) slide.content.splice(idx, 1);
            renderEditor();
        }
        
        function updateSubtitle(sidx, value) {
            const slide = pptData.slides[currentSlideIndex];
            if (slide.subsections) slide.subsections[sidx].subtitle = value;
        }
        
        function updateSubPoint(sidx, pidx, value) {
            const slide = pptData.slides[currentSlideIndex];
            if (slide.subsections) slide.subsections[sidx].points[pidx] = value;
        }
        
        function deleteSubPoint(sidx, pidx) {
            const slide = pptData.slides[currentSlideIndex];
            if (slide.subsections) slide.subsections[sidx].points.splice(pidx, 1);
            renderEditor();
        }
        
        function addSubPoint(sidx) {
            const slide = pptData.slides[currentSlideIndex];
            if (slide.subsections) slide.subsections[sidx].points.push('æ–°è¦ç‚¹');
            renderEditor();
        }
        
        function addSubsection() {
            const slide = pptData.slides[currentSlideIndex];
            if (!slide.subsections) slide.subsections = [];
            slide.subsections.push({ subtitle: 'æ–°å­ä¸»é¢˜', points: ['è¦ç‚¹ 1'] });
            renderEditor();
        }
        
        function deleteCurrentSlide() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¹»ç¯ç‰‡å—ï¼Ÿ')) return;
            pptData.slides.splice(currentSlideIndex, 1);
            currentSlideIndex = Math.max(0, currentSlideIndex - 1);
            if (pptData.slides.length === 0) currentSlideIndex = null;
            updateUI();
            showMessage('å¹»ç¯ç‰‡å·²åˆ é™¤', 'success');
        }
        
        function addNewSlide() {
            pptData.slides.push({
                title: 'æ–°å¹»ç¯ç‰‡',
                type: 'detail',
                points: ['è¦ç‚¹ 1'],
                content: ['è¦ç‚¹ 1']
            });
            currentSlideIndex = pptData.slides.length - 1;
            updateUI();
        }
        
        // AI é‡æ–°ç”Ÿæˆ
        function openRegenerateModal() {
            document.getElementById('regenerate-modal').classList.add('show');
        }
        
        function closeRegenerateModal() {
            document.getElementById('regenerate-modal').classList.remove('show');
            document.getElementById('regenerate-prompt').value = '';
        }
        
        async function doRegenerate() {
            if (currentSlideIndex === null) return;
            
            const customPrompt = document.getElementById('regenerate-prompt').value;
            
            try {
                const response = await fetch(
                    `/api/ppt/regenerate/${sessionId}/${currentSlideIndex}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: customPrompt || null })
                    }
                );
                
                const result = await response.json();
                if (result.success) {
                    // åˆ·æ–°ä¼šè¯æ•°æ®
                    await loadSession();
                    selectSlide(currentSlideIndex);
                    closeRegenerateModal();
                    showMessage('å¹»ç¯ç‰‡å·²é‡æ–°ç”Ÿæˆ', 'success');
                } else {
                    showMessage(`ç”Ÿæˆå¤±è´¥: ${result.error}`, 'error');
                }
            } catch (err) {
                showMessage(`ç”Ÿæˆé”™è¯¯: ${err.message}`, 'error');
            }
        }
        
        // ä¿å­˜å’Œä¸‹è½½
        async function savePPT() {
            try {
                // å…ˆæ›´æ–°å½“å‰ç¼–è¾‘çš„å¹»ç¯ç‰‡
                updateCurrentSlide();
                
                // è°ƒç”¨é‡æ–°æ¸²æŸ“ API
                const response = await fetch(`/api/ppt/render/${sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ theme: 'business' })
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage('PPT æ–‡ä»¶å·²ç”Ÿæˆ', 'success');
                } else {
                    showMessage(`ä¿å­˜å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (err) {
                showMessage(`ä¿å­˜é”™è¯¯: ${err.message}`, 'error');
            }
        }
        
        async function downloadPPT() {
            window.location.href = `/api/ppt/download/${sessionId}`;
        }
        
        function showMessage(text, type) {
            const editor = document.getElementById('editor-content');
            const msg = document.createElement('div');
            msg.className = type;
            msg.textContent = text;
            msg.style.position = 'fixed';
            msg.style.top = '20px';
            msg.style.right = '20px';
            msg.style.zIndex = '2000';
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        }
        
        function getSlideTypeLabel(type) {
            const labels = {
                detail: 'è¯¦ç»†é¡µ',
                overview: 'æ¦‚è§ˆé¡µ',
                highlight: 'äº®ç‚¹é¡µ',
                comparison: 'å¯¹æ¯”é¡µ',
                divider: 'è¿‡æ¸¡é¡µ'
            };
            return labels[type] || type;
        }
        
        // åˆå§‹åŒ–
        initSession();
    </script>
</body>
</html>
