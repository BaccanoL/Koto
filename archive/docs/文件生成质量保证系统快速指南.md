# 🚀 文件生成质量保证系统 - 快速启用指南

## 一句话总结

系统会自动评估生成的文件质量，如果不达标会用AI自动改进，同时实时显示进度条给用户。

## 完整配置流程（5分钟）

### 1. 验证依赖已安装

```bash
pip list | grep -E "python-pptx|google-genai"
```

应该看到：
- `python-pptx` (需要版本 ≥ 0.6.21)
- `google-genai` (已有)

如果缺少，运行：
```bash
pip install python-pptx
```

### 2. 确认按此顺序的文件存在

- ✅ `web/quality_evaluator.py` - 评估器（新）
- ✅ `web/feedback_loop.py` - AI改进（新）
- ✅ `web/progress_tracker.py` - 进度跟踪（新）
- ✅ `web/tool_registry.py` - 已更新
- ✅ `web/app.py` - sys.path 已修复
- ✅ `web/static/js/app.js` - UI函数已添加
- ✅ `web/static/css/style.css` - 样式已添加

### 3. 启动应用

应用已包含所有功能，直接启动即可：

```bash
# 方式1：桌面应用
python koto_app.py

# 方式2：Web服务
cd web && python app.py
```

### 4. 测试功能

运行测试脚本验证所有组件正常：

```bash
python test_quality_system.py
```

应该看到所有测试 ✅ 通过。

## 使用方式

### 方式1：通过Web聊天界面

1. 打开应用：`http://localhost:5000`
2. 输入请求："为我生成一份关于X的分析报告"
3. **自动流程**：
   - ✅ 系统生成初始内容
   - 📊 自动评估质量（显示进度条）
   - ✨ 如果分数<75分，自动改进
   - ⚙️ 生成Word/PDF文件
   - 📈 显示质量评分和反馈

4. 查看生成的文件：`workspace/documents/` 目录

### 方式2：通过Agent（支持自动决策）

没有任何额外配置。Agent会自动：
- 识别FILE_GEN任务
- 调用generate_document工具
- 触发质量评估和改进
- 返回文件路径

## 配置选项（可选）

### A. 禁用自动改进（加快生成）

编辑 `web/tool_registry.py` 第XXX行：

```python
# 改为：
enable_quality_check=False  # 禁用评估和改进
```

或通过工具参数：

```python
result = registry.call_tool("generate_document", {
    "content": "...",
    "enable_quality_check": False
})
```

### B. 调整改进次数

编辑 `web/feedback_loop.py` 第XX行：

```python
self.max_iterations = 1  # 改为1只改进一次（默认2次）
```

### C. 调整评分标准

编辑 `web/quality_evaluator.py`，各评估函数中修改权重。例如，使文档评估更严格：

```python
# 在 DocumentEvaluator._evaluate_length 中
if char_count < 1000:
    return 50.0  # 改为50更严格
```

### D. 自定义评估维度

如需添加新的评估维度（如可读性、SEO等），编辑相应评估器的 `evaluate_*` 方法。

## 常见问题

### Q: 为什么有的文件生成后没改进？

**A**: 如果初始评分 ≥ 75分，系统认为质量达标，不会改进。这是正常的。

### Q: 改进过程中能取消吗？

**A**: 当前版本不支持取消，但改进通常 5-15 秒完成。

### Q: 改进会改变原意吗？

**A**: AI改进主要针对结构、完整性、语言质量等，会保持原意。但建议 review 重要文件。

### Q: 为什么PPT评估分数为0？

**A**: 可能是 python-pptx 无法读取文件。确保：
- 文件格式正确（.pptx）
- python-pptx 版本 ≥ 0.6.21

### Q: 能否针对特定领域调整评估标准？

**A**: 可以。编辑对应的评估器类，修改阈值和权重。例如技术文档可能需要更多代码示例。

## 监控和调试

### 查看日志

所有操作都有日志输出：

```
[文档生成] 质量评估...
[文档生成] 评估完成: 评分 65.2/100
[文档生成] 需要改进，开始第1轮...
[AI反馈循环] Gemini 调用...
[文档生成] 改进完成: 评分 78.5/100
```

### 性能优化建议

- **首次使用**：第一次会加载model较慢（3-5秒）
- **多轮改进**：2轮改进通常 20-40 秒
- **大型PPT**：评估 >50 页PPT可能需要 5+ 秒

对于反复生成同一类型内容，建议：

1. 评估一次后记录评分标准
2. 后续生成禁用评估（`enable_quality_check=False`）
3. 需要时再启用评估

## 与现有系统的集成

### ✅ 已自动集成

- Tool Registry 的 `generate_document` 工具
- Agent 的 FILE_GEN 任务路由
- 前端 SSE 流处理
- 会话管理系统

### 📝 无需修改

- 聊天界面（自动使用新功能）
- Agent 循环（自动调用新工具）
- 数据库或文件系统（存储不变）

## 升级检查清单

如果从旧版本升级，确保：

- [ ] ✅ `web/app.py` 第 15-17 行有 sys.path 摆置
- [ ] ✅ `web/tool_registry.py` 的 `_handle_generate_document` 有进度回调参数
- [ ] ✅ `web/static/js/app.js` 最后有 `displayGenerationProgress` 函数
- [ ] ✅ `web/static/css/style.css` 有 `.generation-progress` 样式
- [ ] ✅ 新建3个文件：`quality_evaluator.py`, `feedback_loop.py`, `progress_tracker.py`

## 回滚（如需禁用此功能）

如果需要关闭质量保证系统，只需：

```python
# web/tool_registry.py 中 _handle_generate_document
enable_quality_check = False  # 全局禁用
```

或删除新加的3个文件（但保留功能代码）。

## 反馈和改进

- 发现bug？检查 `test_quality_system.py` 是否还通过
- 需要新评估维度？修改对应的 Evaluator 类
- 想要不同的AI改进方式？编辑 `feedback_loop.py` 的提示词

## 下一步

1. ✅ 测试基础功能：`python test_quality_system.py`
2. ✅ 启动应用并尝试生成文件
3. ✅ 观察进度条和质量反馈
4. ✅ 根据需要调整配置

**预计完整集成耗时：0 分钟（已完成）**

祝使用愉快！ 🎉
