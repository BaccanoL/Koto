# 🎯 文件生成质量保证系统

## 概述

这个系统为所有文件生成操作（Word、PDF、PowerPoint等）提供了全面的质量控制和自动改进功能。用户无需等待更短的时间，可以看到实时的任务进度，系统会自动评估和改进生成的内容。

## 核心功能

### 1. 自动质量评估 📊

系统在生成文件后会自动评估内容质量，包括：

#### 文档质量评估维度
- **结构完整性**：检查是否有清晰的标题和逻辑结构
- **内容完整性**：验证是否包含引言、正文和结论
- **文本长度**：确保内容充分（400字以上为佳）
- **格式一致性**：检查列表、代码块等格式的统一性
- **语言质量**：识别过长句子和语法问题

#### PPT质量评估维度
- **幻灯片数量**：5-20页最优
- **内容分布**：避免单页内容过多或过少
- **图片分布**：确保至少50%的内容页包含图片
- **排版一致性**：检查布局和字体使用的统一性
- **视觉一致性**：验证颜色和设计元素的协调

### 2. 自动内容改进 ✨

如果评分低于75分，系统会自动尝试改进：

- **最多2轮改进**：每轮都会重新评估效果
- **基于Gemini**：使用大模型根据具体问题改进内容
- **智能优先级**：优先解决最严重的问题
- **渐进式改进**：每轮改进至少提升5分才继续

### 3. 实时进度显示 ⏳

前端会显示详细的进度信息：

```
📋 验证输入 ──────────────────── 0%
📊 评估质量 ████████────────────── 33%
✨ 改进内容 ████████████████────── 66%
⚙️ 生成文件 ██████████████████── 95%
✅ 已完成
```

每个阶段都有清晰的说明和进度百分比。

### 4. 质量反馈信息 📈

生成完成后，用户会看到：

- **综合评分**：0-100分，显示最终内容质量
- **发现的问题**：具体列出的质量问题
- **改进建议**：可采取的改进行动
- **改进历程**：显示经历了几轮改进

## 使用场景

### 场景1：生成一份重要文档

```
用户: "生成一份关于AI发展现状的分析报告"

系统流程:
1. ✅ 验证输入 (0%)
2. 📊 评估质量: 初始评分 62/100
   - 问题: 缺少数据支撑、结论不够深入
   - 建议: 添加具体数据、强化观点
3. ✨ 改进第1轮: 评分提升到 78/100
   - 添加了行业数据
   - 增强了分析深度
4. ⚙️ 生成Word文件
5. ✅ 完成！(评分 78/100)
```

### 场景2：生成演示文稿

```
用户: "为产品发布会生成一份PPT"

系统流程:
1. 📊 评估初始PPT: 评分 68/100
   - 问题: 一些页面文本过多、缺少配图
   - 建议: 调整内容分布、添加更多视觉元素
2. ✨ 自动改进: 调整内容、添加图片描述
3. ✅ 最终评分 82/100
```

## 技术架构

### 模块组成

```
user_request
    ↓
web/app.py (chat_stream endpoint)
    ↓
tool_registry._handle_generate_document
    ↓
┌─────────────────────────────────────┐
│ 第1步: 质量评估 (quality_evaluator) │
├─────────────────────────────────────┤
│ 文档或PPT内容 → DocumentEvaluator  │
│              → PPTEvaluator        │
│                    ↓                │
│              评分结果 (0-100)       │
└─────────────────────────────────────┘
    ↓
    需要改进 (< 75分)?
    ├─ 是 → 第2步: 改进循环
    │       (feedback_loop.py)
    │       ├─ 调用Gemini改进
    │       ├─ 重新评估
    │       └─ 最多2轮
    │
    └─ 否 → 跳过改进
         ↓
┌─────────────────────────────────────┐
│ 第3步: 生成文件 (document_generator)│
├─────────────────────────────────────┤
│ 改进后内容 → Word/PDF生成         │
│              ↓                      │
│          保存到workspace/documents │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 进度反馈 (progress_tracker.py)     │
├─────────────────────────────────────┤
│ SSE事件流推送到前端                 │
│ ├─ type: "generation_progress"     │
│ ├─ stage: validating/...           │
│ ├─ progress_percent: 0-100         │
│ ├─ message: 人类可读的信息          │
│ └─ details: {quality_assessment}   │
└─────────────────────────────────────┘
    ↓
前端显示进度条和质量反馈
```

### 核心文件

| 文件 | 功能 |
|------|------|
| `web/quality_evaluator.py` | PPT和文档质量评估 |
| `web/feedback_loop.py` | AI模型反馈循环和内容改进 |
| `web/progress_tracker.py` | 进度追踪和SSE广播 |
| `web/tool_registry.py` | generate_document工具集成 |
| `web/static/js/app.js` | 前端进度显示 |
| `web/static/css/style.css` | 进度UI样式 |

## API接口

### 生成文档时启用质量检查

```python
# 在 agent 或工具调用中
result = registry.call_tool("generate_document", {
    "content": "...",
    "title": "...",
    "file_type": "docx",  # 或 "pdf"
    "enable_quality_check": True  # 启用质量检查 (默认启用)
})

# 返回结果包含:
{
    "success": true,
    "file_path": "workspace/documents/Report_20260209_143022.docx",
    "quality_assessment": {
        "initial_score": 62.0,
        "was_improved": true,
        "improvement_iterations": 1,
        "final_score": 78.0,
        "issues": ["内容不够完整"],
        "suggestions": ["添加更多细节"]
    }
}
```

### SSE进度事件格式

```json
{
    "type": "generation_progress",
    "task_id": "session_id",
    "stage": "evaluating|improving|generating|completed|error",
    "progress_percent": 33,
    "message": "正在评估文档质量...",
    "timestamp": "2026-02-09T14:30:22.123456",
    "details": {
        "score": 62.0,
        "needs_improvement": true
    }
}
```

## 配置选项

### 在tool_registry中禁用质量检查

```python
# 如果知道内容质量很好，可以禁用：
result = registry.call_tool("generate_document", {
    "content": "...",
    "title": "...",
    "enable_quality_check": False
})
```

### 调整改进参数

编辑 `web/feedback_loop.py`：

```python
self.max_iterations = 2  # 改为1只改进一次，或改为3最多改进3次
```

## 前端集成

### 显示进度条

```javascript
// 在SSE事件处理中
if (data.type === 'generation_progress') {
    displayGenerationProgress(
        containerElement,
        data.progress_percent,
        data.stage,
        data.message
    );
}
```

### 显示质量评估结果

```javascript
// 在生成完成时
if (data.details && data.details.quality_assessment) {
    displayQualityAssessment(
        containerElement,
        data.details.quality_assessment
    );
}
```

## 性能指标

### 评估速度
- 文档评估：< 500ms
- PPT评估：< 1000ms

### 改进速度
- 每轮改进：5-15秒（取决于内容长度）
- 完整流程：15-45秒

### 质量提升
- 平均单轮改进：+8-15 分
- 两轮改进平均提升：+18-25 分

## 已知限制

1. **PPT内容字数限制**：单页超过1500字会被标记为过多
2. **图片分布评估**：基于图片数量而非实际空间占用
3. **改进轮次上限**：最多2轮改进（可配置）
4. **Gemini依赖**：改进功能需要有效的Gemini API密钥

## 未来改进方向

- [ ] 集成视觉AI检查PPT布局和配色
- [ ] 添加用户反馈机制用于评估器优化
- [ ] 支持自定义评分标准
- [ ] PPT图片自动生成和优化
- [ ] 多语言质量评估
- [ ] 实时可视化改进过程

## 故障排除

### 问题：评估器评分过严格或过宽松

**解决**：编辑 `quality_evaluator.py` 调整评分算法的权重。例如：

```python
# 在 _evaluate_slide_contents 中
score -= len(problem_slides) * 15  # 改为 * 10 使评分宽松
```

### 问题：改进后内容与原意偏差大

**解决**：在 `feedback_loop.py` 的改进提示中添加更多约束：

```python
prompt += "\n\n【约束】\n- 保留原文的专业术语\n- 不改变核心论点"
```

### 问题：改进过程太慢

**解决**：禁用改进或减少轮次：

```python
manager.max_iterations = 1  # 只改进一次
```

## 示例使用

### 通过 Web UI

1. 输入："帮我生成一份2026年AI趋势分析报告"
2. 系统自动：
   - 生成初始内容
   - 评估质量（显示进度条）
   - 如果分数< 75分，自动改进
   - 生成最终Word文件
   - 显示质量反馈

### 通过 Agent

```
用户请求 → Agent分类为 FILE_GEN
→ 调用generate_document工具
→ 系统自动评估和改进
→ 返回文件路径和质量评分
```

## 相关文档

- [质量评估器详细文档](quality_evaluator.py) - 评估算法详解
- [反馈循环详细文档](feedback_loop.py) - AI改进流程
- [进度追踪详细文档](progress_tracker.py) - SSE实现细节
- [测试脚本](../test_quality_system.py) - 功能验证
