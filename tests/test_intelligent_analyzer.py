#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
æµ‹è¯•æ™ºèƒ½æ–‡æ¡£åˆ†æå¼•æ“
Test Intelligent Document Analyzer
"""

import os
import sys
import asyncio
from pathlib import Path

# æ·»åŠ webè·¯å¾„åˆ°ç³»ç»Ÿè·¯å¾„
web_dir = Path(__file__).parent / "web"
sys.path.insert(0, str(web_dir))

from web.intelligent_document_analyzer import IntelligentDocumentAnalyzer
from web.document_reader import DocumentReader


class MockLLMClient:
    """æ¨¡æ‹ŸLLMå®¢æˆ·ç«¯ç”¨äºæµ‹è¯•"""
    
    def __init__(self):
        self.call_count = 0
    
    async def chat(self, prompt: str, model_name: str = None, stream: bool = False):
        """æ¨¡æ‹Ÿchatæ¥å£"""
        self.call_count += 1
        
        # æ ¹æ®promptç±»å‹è¿”å›ä¸åŒçš„mockå†…å®¹
        if "æ‘˜è¦" in prompt or "abstract" in prompt.lower():
            return {
                'content': """æœ¬ç ”ç©¶æ¢è®¨äº†ç®—æ³•å½¢å¼ä¸»ä¹‰åœ¨å½“ä»£ç¤¾ä¼šçš„å±æœºã€‚
                
ç ”ç©¶èƒŒæ™¯ï¼šéšç€äººå·¥æ™ºèƒ½å’Œå¤§æ•°æ®æŠ€æœ¯çš„å¿«é€Ÿå‘å±•ï¼Œç®—æ³•å·²ç»æˆä¸ºç°ä»£ç¤¾ä¼šå†³ç­–çš„æ ¸å¿ƒå·¥å…·ã€‚ç„¶è€Œï¼Œè¿‡åº¦ä¾èµ–ç®—æ³•å½¢å¼åŒ–æ–¹æ³•å¯¼è‡´äº†å¯¹å¤æ‚ç¤¾ä¼šç°å®çš„ç®€åŒ–å’Œè¯¯è¯»ã€‚

ç ”ç©¶æ–¹æ³•ï¼šæœ¬æ–‡é‡‡ç”¨ç†è®ºåˆ†æå’Œæ¡ˆä¾‹ç ”ç©¶ç›¸ç»“åˆçš„æ–¹æ³•ï¼Œä»æŠ€æœ¯å“²å­¦å’Œç¤¾ä¼šå­¦åŒé‡è§†è§’å®¡è§†ç®—æ³•å½¢å¼ä¸»ä¹‰çš„æœ¬è´¨ã€è¡¨ç°åŠå…¶ç¤¾ä¼šå½±å“ã€‚

ç ”ç©¶ç»“æœï¼šç ”ç©¶å‘ç°ï¼Œç®—æ³•å½¢å¼ä¸»ä¹‰ä¸»è¦è¡¨ç°åœ¨ä¸‰ä¸ªå±‚é¢ï¼šæŠ€æœ¯å±‚é¢çš„æŠ½è±¡åŒ–å€¾å‘ã€è®¤è¯†è®ºå±‚é¢çš„è¿˜åŸä¸»ä¹‰æ€ç»´ã€ä»¥åŠå®è·µå±‚é¢çš„å†³ç­–è‡ªåŠ¨åŒ–ã€‚è¿™ç§å½¢å¼ä¸»ä¹‰å¯¼è‡´äº†"æ•°å­—ä¹‹çœ¼"çš„å±æœºâ€”â€”ç®—æ³•çœ‹ä¼¼ç²¾ç¡®å´æ— æ³•æ•æ‰äººç±»ç¤¾ä¼šçš„å¤æ‚æ€§å’Œä»·å€¼å¤šå…ƒæ€§ã€‚

ç ”ç©¶ç»“è®ºï¼šè¦å…‹æœç®—æ³•å½¢å¼ä¸»ä¹‰å±æœºï¼Œéœ€è¦åœ¨æŠ€æœ¯è®¾è®¡ä¸­å¼•å…¥æƒ…å¢ƒç†æ€§ã€åœ¨ç®—æ³•åº”ç”¨ä¸­ä¿æŒäººæ–‡å…³æ€€ã€åœ¨åˆ¶åº¦å»ºè®¾ä¸­å¼ºåŒ–ç®—æ³•é—®è´£ã€‚æœ¬ç ”ç©¶ä¸ºç†è§£å’Œåº”å¯¹ç®—æ³•ç¤¾ä¼šçš„æŒ‘æˆ˜æä¾›äº†ç†è®ºæ¡†æ¶å’Œå®è·µè·¯å¾„ã€‚"""
            }
        
        elif "å¼•è¨€" in prompt or "introduction" in prompt.lower():
            return {
                'content': """ä¸€ã€é—®é¢˜çš„æå‡º

ç®—æ³•æŠ€æœ¯çš„å¿«é€Ÿå‘å±•æ·±åˆ»æ”¹å˜äº†å½“ä»£ç¤¾ä¼šçš„è¿è¡Œé€»è¾‘ã€‚ä»æœç´¢å¼•æ“çš„ä¿¡æ¯æ’åºï¼Œåˆ°ç¤¾äº¤åª’ä½“çš„å†…å®¹æ¨èï¼Œå†åˆ°å¸æ³•ç³»ç»Ÿçš„é‡åˆ‘å»ºè®®ï¼Œç®—æ³•å·²ç»æ¸—é€åˆ°ç¤¾ä¼šç”Ÿæ´»çš„æ–¹æ–¹é¢é¢ã€‚ç„¶è€Œï¼Œåœ¨ç®—æ³•åº”ç”¨æ—¥ç›Šå¹¿æ³›çš„åŒæ—¶ï¼Œä¸€ç§"ç®—æ³•å½¢å¼ä¸»ä¹‰"çš„å€¾å‘ä¹Ÿæ—¥ç›Šæ˜æ˜¾â€”â€”å³è¿‡åº¦ç›¸ä¿¡ç®—æ³•çš„å½¢å¼åŒ–æ–¹æ³•èƒ½å¤Ÿè§£å†³ä¸€åˆ‡é—®é¢˜ï¼Œå¿½è§†äº†ç¤¾ä¼šç°å®çš„å¤æ‚æ€§å’Œä»·å€¼åˆ¤æ–­çš„å¿…è¦æ€§ã€‚è¿™ç§å€¾å‘å¼•å‘äº†æœ¬æ–‡æ‰€å…³æ³¨çš„æ ¸å¿ƒé—®é¢˜ï¼šç®—æ³•å½¢å¼ä¸»ä¹‰çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿå®ƒå¦‚ä½•å½±å“æˆ‘ä»¬çš„è®¤çŸ¥å’Œå®è·µï¼Ÿæˆ‘ä»¬åº”å½“å¦‚ä½•åº”å¯¹ï¼Ÿ

äºŒã€ç ”ç©¶çš„å±‚æ¬¡å±•å¼€

æœ¬æ–‡é‡‡ç”¨å±‚å±‚é€’è¿›çš„è®ºè¯ç»“æ„æ¥å›ç­”ä¸Šè¿°é—®é¢˜ã€‚ç¬¬äºŒç« å°†ä»æŠ€æœ¯å“²å­¦çš„è§’åº¦ï¼Œåˆ†æç®—æ³•å½¢å¼ä¸»ä¹‰çš„è®¤è¯†è®ºæ ¹æºï¼Œæ­ç¤ºå…¶èƒŒåçš„è¿˜åŸä¸»ä¹‰æ€ç»´æ¨¡å¼åŠå…¶å±€é™æ€§ã€‚ç¬¬ä¸‰ç« è½¬å‘å®è·µå±‚é¢ï¼Œé€šè¿‡å…·ä½“æ¡ˆä¾‹å‰–æç®—æ³•å½¢å¼ä¸»ä¹‰åœ¨ä¸åŒé¢†åŸŸçš„è¡¨ç°å½¢å¼ï¼Œç‰¹åˆ«æ˜¯åœ¨å†³ç­–è‡ªåŠ¨åŒ–è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä»·å€¼å†²çªå’Œä¼¦ç†å›°å¢ƒã€‚ç¬¬å››ç« åœ¨ç†è®ºå’Œå®è·µåˆ†æçš„åŸºç¡€ä¸Šï¼Œæå‡º"æ•°å­—ä¹‹çœ¼çš„å±æœº"è¿™ä¸€æ ¸å¿ƒæ¦‚å¿µï¼ŒæŒ‡å‡ºç®—æ³•å½¢å¼ä¸»ä¹‰å¯¼è‡´äº†æŠ€æœ¯ç†æ€§ä¸äººæ–‡ä»·å€¼ä¹‹é—´çš„æ·±åˆ»å¼ åŠ›ã€‚ç¬¬äº”ç« åˆ™æ¢è®¨å…‹æœç®—æ³•å½¢å¼ä¸»ä¹‰çš„å¯èƒ½è·¯å¾„ï¼Œæå‡ºæƒ…å¢ƒç†æ€§ã€äººæ–‡å…³æ€€å’Œç®—æ³•é—®è´£ä¸‰ä¸ªç»´åº¦çš„è§£å†³æ¡†æ¶ã€‚

ä¸‰ã€ç ”ç©¶çš„æ„ä¹‰

æœ¬ç ”ç©¶çš„ç†è®ºæ„ä¹‰åœ¨äºï¼Œå®ƒå°†ç®—æ³•é—®é¢˜ç½®äºæŠ€æœ¯å“²å­¦å’Œç¤¾ä¼šç†è®ºçš„åŒé‡è§†é‡ä¸­ï¼Œæ­ç¤ºäº†ç®—æ³•å½¢å¼ä¸»ä¹‰ä½œä¸ºä¸€ç§è®¤è¯†è®ºå’Œæ–¹æ³•è®ºå±æœºçš„æ·±å±‚æœ¬è´¨ã€‚å®è·µæ„ä¹‰åœ¨äºï¼Œå®ƒä¸ºç®—æ³•æ²»ç†å’ŒæŠ€æœ¯ä¼¦ç†å»ºè®¾æä¾›äº†æ‰¹åˆ¤æ€§åæ€çš„åŸºç¡€å’Œå»ºè®¾æ€§çš„æ”¹é©æ–¹å‘ã€‚åœ¨ç®—æ³•æ·±åº¦åµŒå…¥ç¤¾ä¼šçš„ä»Šå¤©ï¼Œè¿™ç§åæ€å’Œæ”¹é©å…·æœ‰ç´§è¿«çš„ç°å®ä»·å€¼ã€‚"""
            }
        
        elif "ç»“è®º" in prompt or "conclusion" in prompt.lower():
            return {
                'content': """æœ¬æ–‡ç³»ç»Ÿæ¢è®¨äº†ç®—æ³•å½¢å¼ä¸»ä¹‰å±æœºçš„å¤šä¸ªå±‚é¢ï¼Œç°æ€»ç»“å¦‚ä¸‹ï¼š

ä¸€ã€ç®—æ³•å½¢å¼ä¸»ä¹‰çš„è®¤è¯†è®ºæ ¹æºï¼ˆç¬¬äºŒç« ï¼‰

ç¬¬äºŒç« ä»æŠ€æœ¯å“²å­¦çš„è§’åº¦å‡ºå‘ï¼Œæ­ç¤ºäº†ç®—æ³•å½¢å¼ä¸»ä¹‰çš„è®¤è¯†è®ºæ ¹æºåœ¨äºè¿˜åŸä¸»ä¹‰æ€ç»´æ¨¡å¼ã€‚è¿™ç§æ€ç»´æ¨¡å¼è¯•å›¾å°†å¤æ‚çš„ç¤¾ä¼šç°å®ç®€åŒ–ä¸ºå¯è®¡ç®—çš„å½¢å¼åŒ–ç»“æ„ï¼Œå¿½è§†äº†äººç±»ç¤¾ä¼šçš„æƒ…å¢ƒä¾èµ–æ€§ã€ä»·å€¼å¤šå…ƒæ€§å’Œå†å²åŠ¨æ€æ€§ã€‚ç ”ç©¶è¡¨æ˜ï¼Œç®—æ³•çš„æŠ½è±¡åŒ–è¿‡ç¨‹è™½ç„¶æé«˜äº†è®¡ç®—æ•ˆç‡ï¼Œä½†ä¹Ÿå¯¼è‡´äº†å¯¹ç¤¾ä¼šå¤æ‚æ€§çš„ç³»ç»Ÿæ€§è¯¯è¯»ã€‚

äºŒã€ç®—æ³•å½¢å¼ä¸»ä¹‰çš„å®è·µè¡¨å¾ï¼ˆç¬¬ä¸‰ç« ï¼‰

ç¬¬ä¸‰ç« é€šè¿‡æ¡ˆä¾‹åˆ†æå±•ç¤ºäº†ç®—æ³•å½¢å¼ä¸»ä¹‰åœ¨å¸æ³•ã€æ•™è‚²ã€å°±ä¸šç­‰é¢†åŸŸçš„å…·ä½“è¡¨ç°ã€‚ç ”ç©¶å‘ç°ï¼Œè¿‡åº¦ä¾èµ–ç®—æ³•å†³ç­–å¯¼è‡´äº†ä¸‰ä¸ªçªå‡ºé—®é¢˜ï¼šä¸€æ˜¯å†³ç­–è¿‡ç¨‹çš„"é»‘ç®±åŒ–"ï¼Œå‰Šå¼±äº†äººç±»çš„ä¸»ä½“æ€§ï¼›äºŒæ˜¯ä»·å€¼åˆ¤æ–­çš„"æŠ€æœ¯åŒ–"ï¼Œå›é¿äº†ä¼¦ç†è´£ä»»ï¼›ä¸‰æ˜¯ç¤¾ä¼šæ²»ç†çš„"å»æ”¿æ²»åŒ–"ï¼Œæ©ç›–äº†æƒåŠ›å…³ç³»ã€‚è¿™äº›é—®é¢˜å…±åŒæŒ‡å‘äº†ç®—æ³•å½¢å¼ä¸»ä¹‰åœ¨å®è·µå±‚é¢çš„ä¸¥é‡åæœã€‚

ä¸‰ã€"æ•°å­—ä¹‹çœ¼"çš„å±æœºè¯Šæ–­ï¼ˆç¬¬å››ç« ï¼‰

ç¬¬å››ç« æå‡ºäº†"æ•°å­—ä¹‹çœ¼çš„å±æœº"è¿™ä¸€æ ¸å¿ƒæ¦‚å¿µï¼ŒæŒ‡å‡ºç®—æ³•å½¢å¼ä¸»ä¹‰çš„æœ¬è´¨æ˜¯æŠ€æœ¯ç†æ€§çš„åƒ­è¶Šâ€”â€”å®ƒè¯•å›¾ç”¨å½¢å¼åŒ–çš„è®¡ç®—é€»è¾‘å–ä»£äººç±»çš„ä»·å€¼åˆ¤æ–­å’Œæƒ…å¢ƒç†è§£ã€‚è¿™ç§å±æœºçš„æ·±å±‚æ ¹æºåœ¨äºç°ä»£æ€§çš„å·¥å…·ç†æ€§ä¼ ç»Ÿï¼Œè€Œå…¶å½“ä»£è¡¨ç°åˆ™æ˜¯ç®—æ³•æƒåŠ›çš„æ‰©å¼ ã€‚"æ•°å­—ä¹‹çœ¼"çœ‹ä¼¼ç²¾ç¡®å´ç›²ç›®ï¼Œçœ‹ä¼¼å®¢è§‚å´åé¢‡ï¼Œè¿™æ­£æ˜¯ç®—æ³•å½¢å¼ä¸»ä¹‰æœ€æ·±åˆ»çš„æ‚–è®ºã€‚

å››ã€å…‹æœå±æœºçš„å¯èƒ½è·¯å¾„ï¼ˆç¬¬äº”ç« ï¼‰

ç¬¬äº”ç« æ¢è®¨äº†å…‹æœç®—æ³•å½¢å¼ä¸»ä¹‰å±æœºçš„ä¸‰æ¡è·¯å¾„ï¼šæŠ€æœ¯å±‚é¢å¼•å…¥æƒ…å¢ƒç†æ€§ï¼Œæ‰¿è®¤ç®—æ³•çš„å±€é™æ€§å’Œæƒ…å¢ƒä¾èµ–æ€§ï¼›åº”ç”¨å±‚é¢ä¿æŒäººæ–‡å…³æ€€ï¼Œåœ¨ç®—æ³•å†³ç­–ä¸­ä¿ç•™äººç±»çš„ä»·å€¼åˆ¤æ–­ç©ºé—´ï¼›åˆ¶åº¦å±‚é¢å¼ºåŒ–ç®—æ³•é—®è´£ï¼Œå»ºç«‹é€æ˜ã€å¯è§£é‡Šã€å¯é—®è´£çš„ç®—æ³•æ²»ç†æœºåˆ¶ã€‚è¿™ä¸‰æ¡è·¯å¾„ç›¸äº’æ”¯æ’‘ï¼Œå…±åŒæ„æˆäº†åº”å¯¹ç®—æ³•å½¢å¼ä¸»ä¹‰å±æœºçš„ç»¼åˆæ¡†æ¶ã€‚

äº”ã€ç ”ç©¶è´¡çŒ®ä¸å±€é™

æœ¬ç ”ç©¶çš„ä¸»è¦è´¡çŒ®åœ¨äºï¼šç¬¬ä¸€ï¼Œä»æŠ€æœ¯å“²å­¦è§’åº¦ç³»ç»Ÿé˜é‡Šäº†ç®—æ³•å½¢å¼ä¸»ä¹‰çš„è®¤è¯†è®ºæœ¬è´¨ï¼›ç¬¬äºŒï¼Œé€šè¿‡å®è¯æ¡ˆä¾‹æ­ç¤ºäº†ç®—æ³•å½¢å¼ä¸»ä¹‰çš„å®è·µåæœï¼›ç¬¬ä¸‰ï¼Œæå‡ºäº†"æ•°å­—ä¹‹çœ¼çš„å±æœº"è¿™ä¸€ç†è®ºæ¡†æ¶ï¼›ç¬¬å››ï¼Œæ„å»ºäº†å…‹æœå±æœºçš„å¤šç»´åº¦è§£å†³æ–¹æ¡ˆã€‚

åŒæ—¶ï¼Œæœ¬ç ”ç©¶ä¹Ÿå­˜åœ¨ä¸€å®šå±€é™æ€§ã€‚ä¸»è¦ä½“ç°åœ¨ï¼šç¬¬ä¸€ï¼Œæ¡ˆä¾‹åˆ†æä¸»è¦é›†ä¸­äºç‰¹å®šé¢†åŸŸï¼Œæœªèƒ½æ¶µç›–ç®—æ³•åº”ç”¨çš„å…¨éƒ¨åœºæ™¯ï¼›ç¬¬äºŒï¼Œå¯¹ç®—æ³•å†…éƒ¨æŠ€æœ¯ç»†èŠ‚çš„è®¨è®ºç›¸å¯¹æœ‰é™ï¼Œæ›´å¤šèšç„¦äºå…¶ç¤¾ä¼šå’Œå“²å­¦å±‚é¢ï¼›ç¬¬ä¸‰ï¼Œæå‡ºçš„è§£å†³è·¯å¾„éœ€è¦åœ¨æ›´å¹¿æ³›çš„å®è·µä¸­æ£€éªŒå…¶æœ‰æ•ˆæ€§ã€‚

å…­ã€æœªæ¥ç ”ç©¶æ–¹å‘

æœªæ¥ç ”ç©¶å¯ä»¥åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹å‘æ·±åŒ–ï¼šç¬¬ä¸€ï¼Œå¼€å±•è·¨æ–‡åŒ–æ¯”è¾ƒç ”ç©¶ï¼Œæ¢è®¨ä¸åŒç¤¾ä¼šæ–‡åŒ–èƒŒæ™¯ä¸‹ç®—æ³•å½¢å¼ä¸»ä¹‰çš„å·®å¼‚æ€§è¡¨ç°ï¼›ç¬¬äºŒï¼Œä¸è®¡ç®—æœºç§‘å­¦å®¶åˆä½œï¼Œæ¢ç´¢åœ¨æŠ€æœ¯å±‚é¢å®ç°æƒ…å¢ƒç†æ€§çš„å…·ä½“æ–¹æ³•ï¼›ç¬¬ä¸‰ï¼Œå¼€å±•è¿½è¸ªç ”ç©¶ï¼Œè¯„ä¼°ç®—æ³•æ²»ç†æ”¿ç­–çš„é•¿æœŸæ•ˆæœï¼›ç¬¬å››ï¼Œæ‰©å±•åˆ°æ–°å…´é¢†åŸŸå¦‚ç”Ÿæˆå¼AIï¼Œåˆ†æå…¶å¸¦æ¥çš„æ–°å‹å½¢å¼ä¸»ä¹‰æŒ‘æˆ˜ã€‚

æ€»ä¹‹ï¼Œç®—æ³•å½¢å¼ä¸»ä¹‰å±æœºæ˜¯å½“ä»£æŠ€æœ¯ç¤¾ä¼šé¢ä¸´çš„æ ¹æœ¬æ€§æŒ‘æˆ˜ä¹‹ä¸€ã€‚å…‹æœè¿™ä¸€å±æœºä¸ä»…éœ€è¦æŠ€æœ¯åˆ›æ–°ï¼Œæ›´éœ€è¦å“²å­¦åæ€ã€ä¼¦ç†è‡ªè§‰å’Œåˆ¶åº¦ä¿éšœã€‚åªæœ‰åœ¨æŠ€æœ¯ç†æ€§ä¸äººæ–‡ä»·å€¼ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ï¼Œæˆ‘ä»¬æ‰èƒ½çœŸæ­£é©¾é©­ç®—æ³•æŠ€æœ¯ï¼Œè€Œä¸æ˜¯è¢«å…¶æ‰€é©¾é©­ã€‚"""
            }
        
        return {
            'content': f"[Mock LLM Response for call #{self.call_count}]\n{prompt[:200]}..."
        }


async def test_document_structure_analysis():
    """æµ‹è¯•æ–‡æ¡£ç»“æ„åˆ†æ"""
    print("\n" + "="*60)
    print("æµ‹è¯•1: æ–‡æ¡£ç»“æ„åˆ†æ")
    print("="*60)
    
    # ä½¿ç”¨å®é™…çš„è®ºæ–‡æ–‡ä»¶
    doc_path = Path(__file__).parent / "web" / "uploads" / "æ•°å­—ä¹‹çœ¼çš„å±æœº^L7ç®—æ³•çš„å½¢å¼ä¸»ä¹‰å±æœº(1).docx"
    
    if not doc_path.exists():
        print(f"âŒ æ–‡æ¡£ä¸å­˜åœ¨: {doc_path}")
        return False
    
    print(f"ğŸ“„ è¯»å–æ–‡æ¡£: {doc_path.name}")
    
    try:
        doc_structure = DocumentReader.read_word(str(doc_path))
        
        if not doc_structure.get('success'):
            print(f"âŒ è¯»å–å¤±è´¥: {doc_structure.get('error')}")
            return False
        
        paragraphs = doc_structure.get('paragraphs', [])
        print(f"âœ… æˆåŠŸè¯»å– {len(paragraphs)} ä¸ªæ®µè½")
        
        # æ˜¾ç¤ºæ–‡æ¡£ç»“æ„
        print("\næ–‡æ¡£ç»“æ„æ¦‚è§ˆ:")
        headings = [
            (idx, p['text'][:50], p.get('level', 1))
            for idx, p in enumerate(paragraphs)
            if p.get('type') == 'heading'
        ]
        
        for idx, text, level in headings[:10]:  # æ˜¾ç¤ºå‰10ä¸ªæ ‡é¢˜
            indent = '  ' * (level - 1)
            print(f"  {indent}[{idx}] {text}")
        
        return True
    
    except Exception as e:
        print(f"âŒ å¼‚å¸¸: {str(e)}")
        import traceback
        traceback.print_exc()
        return False


async def test_request_analysis():
    """æµ‹è¯•è¯·æ±‚æ„å›¾åˆ†æ"""
    print("\n" + "="*60)
    print("æµ‹è¯•2: è¯·æ±‚æ„å›¾åˆ†æ")
    print("="*60)
    
    mock_client = MockLLMClient()
    analyzer = IntelligentDocumentAnalyzer(mock_client)
    
    # æµ‹è¯•ç”¨ä¾‹
    test_cases = [
        {
            'input': 'å†™ä¸€æ®µæ‘˜è¦ï¼Œ300-400å­—ï¼ŒåŒ…å«ç ”ç©¶èƒŒæ™¯ã€æ–¹æ³•ã€ç»“æœã€ç»“è®º',
            'expected_tasks': ['write_abstract']
        },
        {
            'input': 'æ”¹è¿›å¼•è¨€éƒ¨åˆ†ï¼Œä½¿å…¶ä¸æ–‡ç« æ¶æ„ç›¸ç¬¦',
            'expected_tasks': ['revise_intro']
        },
        {
            'input': 'é‡æ–°æ”¹å–„å¼•è¨€ï¼Œå¹¶æ”¹å–„ç»“è®º',
            'expected_tasks': ['revise_intro', 'revise_conclusion']
        },
        {
            'input': 'å†™ä¸€æ®µæ‘˜è¦ï¼Œ300-400å­—ï¼›é‡æ–°æ”¹å–„å¼•è¨€ï¼Œè®©å…¶ä¸æ–‡ç« ä¸»ä½“æ¶æ„ç›¸ç¬¦ï¼›æ”¹å–„ç»“è®ºï¼Œovercapæ•´ç¯‡æ–‡ç« å†…å®¹',
            'expected_tasks': ['write_abstract', 'revise_intro', 'revise_conclusion']
        }
    ]
    
    doc_path = Path(__file__).parent / "web" / "uploads" / "æ•°å­—ä¹‹çœ¼çš„å±æœº^L7ç®—æ³•çš„å½¢å¼ä¸»ä¹‰å±æœº(1).docx"
    doc_structure = DocumentReader.read_word(str(doc_path))
    
    all_pass = True
    for idx, test in enumerate(test_cases, 1):
        print(f"\næµ‹è¯•ç”¨ä¾‹ {idx}:")
        print(f"  è¾“å…¥: {test['input']}")
        
        result = analyzer.analyze_request(test['input'], doc_structure)
        
        detected_task_types = [t['type'] for t in result['tasks']]
        print(f"  æ£€æµ‹åˆ°çš„ä»»åŠ¡: {detected_task_types}")
        print(f"  æ–‡æ¡£ç±»å‹: {result['document_type']}")
        print(f"  æ˜¯å¦å¤šä»»åŠ¡: {result['is_multi_task']}")
        print(f"  ç½®ä¿¡åº¦: {result['confidence']:.2f}")
        
        # éªŒè¯æ˜¯å¦åŒ…å«é¢„æœŸä»»åŠ¡
        expected_found = all(exp in detected_task_types for exp in test['expected_tasks'])
        if expected_found:
            print(f"  âœ… é€šè¿‡")
        else:
            print(f"  âŒ å¤±è´¥ - é¢„æœŸä»»åŠ¡: {test['expected_tasks']}")
            all_pass = False
    
    return all_pass


async def test_prompt_generation():
    """æµ‹è¯•ä¸“ç”¨æç¤ºè¯ç”Ÿæˆ"""
    print("\n" + "="*60)
    print("æµ‹è¯•3: ä¸“ç”¨æç¤ºè¯ç”Ÿæˆ")
    print("="*60)
    
    mock_client = MockLLMClient()
    analyzer = IntelligentDocumentAnalyzer(mock_client)
    
    doc_path = Path(__file__).parent / "web" / "uploads" / "æ•°å­—ä¹‹çœ¼çš„å±æœº^L7ç®—æ³•çš„å½¢å¼ä¸»ä¹‰å±æœº(1).docx"
    doc_structure = DocumentReader.read_word(str(doc_path))
    
    # æµ‹è¯•æ‘˜è¦ä»»åŠ¡æç¤ºè¯
    task = {
        'type': 'write_abstract',
        'description': 'ç”Ÿæˆè®ºæ–‡æ‘˜è¦',
        'target_sections': ['paragraph_0']
    }
    
    user_input = 'å†™ä¸€æ®µæ‘˜è¦ï¼Œ300-400å­—'
    
    prompt = analyzer.generate_specialized_prompt(task, doc_structure, user_input)
    
    print(f"ä»»åŠ¡ç±»å‹: {task['type']}")
    print(f"ç”Ÿæˆçš„æç¤ºè¯é•¿åº¦: {len(prompt)} å­—ç¬¦")
    print(f"\næç¤ºè¯å‰300å­—:")
    print(prompt[:300])
    
    # æ£€æŸ¥æç¤ºè¯æ˜¯å¦åŒ…å«å…³é”®è¦ç´ 
    required_elements = ['ç ”ç©¶èƒŒæ™¯', 'ç ”ç©¶æ–¹æ³•', 'ç ”ç©¶ç»“æœ', 'ç ”ç©¶ç»“è®º', '300-400']
    found_elements = [elem for elem in required_elements if elem in prompt]
    
    print(f"\nâœ… åŒ…å«çš„å…³é”®è¦ç´ : {found_elements}")
    
    if len(found_elements) >= 4:
        print("âœ… æç¤ºè¯è´¨é‡åˆæ ¼")
        return True
    else:
        print("âŒ æç¤ºè¯ç¼ºå°‘å¿…è¦å…ƒç´ ")
        return False


async def test_full_streaming_process():
    """æµ‹è¯•å®Œæ•´çš„æµå¼å¤„ç†æµç¨‹"""
    print("\n" + "="*60)
    print("æµ‹è¯•4: å®Œæ•´æµå¼å¤„ç†æµç¨‹ï¼ˆä½¿ç”¨Mock LLMï¼‰")
    print("="*60)
    
    mock_client = MockLLMClient()
    analyzer = IntelligentDocumentAnalyzer(mock_client)
    
    doc_path = Path(__file__).parent / "web" / "uploads" / "æ•°å­—ä¹‹çœ¼çš„å±æœº^L7ç®—æ³•çš„å½¢å¼ä¸»ä¹‰å±æœº(1).docx"
    output_dir = Path(__file__).parent / "workspace" / "test_output"
    output_dir.mkdir(parents=True, exist_ok=True)
    
    user_input = 'å†™ä¸€æ®µæ‘˜è¦ï¼Œ300-400å­—ï¼›é‡æ–°æ”¹å–„å¼•è¨€ï¼›æ”¹å–„ç»“è®º'
    
    print(f"ğŸ“„ æ–‡æ¡£: {doc_path.name}")
    print(f"ğŸ“ è¯·æ±‚: {user_input}")
    print(f"ğŸ“ è¾“å‡ºç›®å½•: {output_dir}")
    print("\nå¼€å§‹æµå¼å¤„ç†...\n")
    
    try:
        event_count = 0
        async for event in analyzer.process_document_revision_streaming(
            str(doc_path),
            user_input,
            str(output_dir)
        ):
            event_count += 1
            stage = event.get('stage', 'unknown')
            progress = event.get('progress', 0)
            message = event.get('message', '')
            
            print(f"[{event_count}] {stage.upper():15} | {progress:3}% | {message}")
            
            if 'detail' in event:
                detail = event['detail']
                if len(detail) > 100:
                    print(f"      è¯¦æƒ…: {detail[:100]}...")
                else:
                    print(f"      è¯¦æƒ…: {detail}")
        
        print(f"\nâœ… æµå¼å¤„ç†å®Œæˆï¼Œå…± {event_count} ä¸ªäº‹ä»¶")
        print(f"âœ… LLMè°ƒç”¨æ¬¡æ•°: {mock_client.call_count}")
        
        return True
    
    except Exception as e:
        print(f"\nâŒ æµå¼å¤„ç†å¤±è´¥: {str(e)}")
        import traceback
        traceback.print_exc()
        return False


async def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("="*60)
    print("æ™ºèƒ½æ–‡æ¡£åˆ†æå¼•æ“ - ç»¼åˆæµ‹è¯•")
    print("="*60)
    
    results = []
    
    # æµ‹è¯•1: æ–‡æ¡£ç»“æ„åˆ†æ
    result1 = await test_document_structure_analysis()
    results.append(('æ–‡æ¡£ç»“æ„åˆ†æ', result1))
    
    # æµ‹è¯•2: è¯·æ±‚æ„å›¾åˆ†æ
    result2 = await test_request_analysis()
    results.append(('è¯·æ±‚æ„å›¾åˆ†æ', result2))
    
    # æµ‹è¯•3: æç¤ºè¯ç”Ÿæˆ
    result3 = await test_prompt_generation()
    results.append(('ä¸“ç”¨æç¤ºè¯ç”Ÿæˆ', result3))
    
    # æµ‹è¯•4: å®Œæ•´æµå¼å¤„ç†
    result4 = await test_full_streaming_process()
    results.append(('å®Œæ•´æµå¼å¤„ç†', result4))
    
    # æ±‡æ€»ç»“æœ
    print("\n" + "="*60)
    print("æµ‹è¯•ç»“æœæ±‡æ€»")
    print("="*60)
    
    for test_name, passed in results:
        status = "âœ… é€šè¿‡" if passed else "âŒ å¤±è´¥"
        print(f"{test_name:20} : {status}")
    
    total_pass = sum(1 for _, passed in results if passed)
    total_tests = len(results)
    
    print(f"\næ€»è®¡: {total_pass}/{total_tests} ä¸ªæµ‹è¯•é€šè¿‡")
    
    if total_pass == total_tests:
        print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ™ºèƒ½æ–‡æ¡£åˆ†æå¼•æ“å·¥ä½œæ­£å¸¸ã€‚")
    else:
        print(f"\nâš ï¸  æœ‰ {total_tests - total_pass} ä¸ªæµ‹è¯•å¤±è´¥ï¼Œéœ€è¦ä¿®å¤ã€‚")


if __name__ == '__main__':
    asyncio.run(main())
